<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Trade Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #00BFFF; /* Deep Sky Blue - vibrant accent */
            --secondary-color: #32CD32; /* Lime Green - another accent */
            --dark-bg: #1A1A2E; /* Very Dark Blue - main background */
            --light-bg: #2C2C40; /* Slightly lighter dark blue for sections */
            --card-bg: #212135; /* Darker card background */
            --text-color: #E0E0E0; /* Light grey for text */
            --success-color: #2ECC71; /* Green */
            --error-color: #E74C3C; /* Red */
            --neutral-color: #95A5A6; /* Medium grey for neutral elements */
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #11111F 100%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll due to animations */
        }

        #header {
            background-color: var(--card-bg);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 15px; /* Spacing for wrapped items */
        }
        #header h1 {
            margin: 0;
            font-size: 2.2em;
            letter-spacing: 1.5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: var(--primary-color);
        }
        #header-right {
            display: flex;
            align-items: center;
            gap: 25px;
            flex-wrap: wrap; /* Allow wrapping */
            justify-content: flex-end;
        }
        #user-info {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--secondary-color);
        }
        #balance-display, #account-pl-display {
            font-size: 1.2em;
            font-weight: 700;
            background-color: rgba(0,0,0,0.3);
            padding: 8px 18px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #balance-display span, #account-pl-display span {
            margin-left: 8px;
        }
        #balance-display #user-balance {
            color: var(--success-color);
        }
        #account-pl-value {
            color: var(--neutral-color); /* Default neutral */
        }
        #account-pl-value.profit { color: var(--success-color); }
        #account-pl-value.loss { color: var(--error-color); }


        #logout-btn, #login-btn, #reset-account-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        #logout-btn:hover, #login-btn:hover, #reset-account-btn:hover {
            background-color: #009ACD;
            transform: translateY(-2px);
        }
        #logout-btn:active, #login-btn:active, #reset-account-btn:active {
            transform: translateY(0);
        }
        #reset-account-btn {
            background-color: var(--error-color); /* Distinct color for reset */
            margin-left: 10px; /* Spacing */
        }
        #reset-account-btn:hover {
            background-color: #C0392B;
        }

        /* Currency and Country Selectors */
        .header-select-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-select-group label {
            font-size: 1em;
            color: var(--text-color);
            font-weight: 600;
        }

        .header-select-group select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #3A3A50;
            color: var(--text-color);
            font-size: 1em;
            cursor: pointer;
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20512%22%3E%3Cpath%20fill%3D%22%23E0E0E0%22%20d%3D%22M192%20256L64%20128v256l128-128z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .header-select-group select:hover {
            border-color: var(--primary-color);
        }
        .header-select-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(50, 205, 50, 0.2);
        }



    #main-content {
        display: flex;
        flex: 1;
        padding: 15px;
        gap: 20px;
        max-width: 100%; /* Ensures the main content takes full available width */
        margin: 15px auto;
        animation: slideInFromTop 0.8s ease-out;
        flex-direction: column;
    }

    /* ... (existing CSS) ... */

   #companies-grid {
        display: grid;
        /* Sets the grid to have exactly 4 columns of equal width */
        grid-template-columns: repeat(4, 1fr);
        gap: 15px; /* Keeps the existing gap between items */
        margin-top: 15px;
    }


        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tabs Styling */
        .tabs-container {
            width: 100%;
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px; /* Space between tabs and content */
        }

        .tab-buttons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--neutral-color);
            transition: color 0.3s ease, border-bottom 0.3s ease;
            position: relative;
            flex-grow: 1; /* Allow buttons to grow and fill space */
            text-align: center;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -10px; /* Position below the button, accounting for padding-bottom */
            width: 100%;
            height: 3px;
            background-color: transparent;
            transition: background-color 0.3s ease;
        }

        .tab-button.active {
            color: var(--primary-color);
            /* border-bottom: 3px solid var(--primary-color); */
        }
        .tab-button.active::after {
            background-color: var(--primary-color);
        }

        .tab-button:hover:not(.active) {
            color: var(--text-color);
        }

        .tab-content {
            display: none;
            padding-top: 15px;
        }

        .tab-content.active {
            display: block;
        }


        .section-container h2 {
            color: var(--primary-color);
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
            font-size: 1.8em;
            font-weight: 600;
            text-align: center;
        }
        .section-container {
            /* Removed flex properties as it's now handled by tab-content */
            /* Removed background, border-radius, box-shadow, padding as it's now handled by tabs-container */
        }



        .company-card {
            background: linear-gradient(145deg, var(--light-bg), #3A3A50);
            border: 1px solid #444460;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
            position: relative;
            width: 100%; /* Ensure cards take full available width in their grid column */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .company-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: translateY(-100%);
            transition: transform 0.3s ease-out;
        }
        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border-color: var(--primary-color);
        }
        .company-card:hover::before {
            transform: translateY(0);
        }

        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .company-name {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
        }
        .company-symbol {
            font-size: 1em;
            color: var(--neutral-color);
            margin-bottom: 12px;
        }
        .company-country { /* New style for country */
            font-size: 0.9em;
            color: var(--neutral-color);
            margin-top: -8px; /* Adjust spacing */
            margin-bottom: 10px;
        }
        .company-details {
            font-size: 1.1em;
            color: var(--text-color);
        }
        .stock-price {
            font-size: 1.4em;
            font-weight: 700;
            display: inline-block;
            margin-top: 8px;
        }
        .price-change {
            font-size: 1em;
            margin-left: 10px;
            font-weight: 600;
            display: inline-block;
        }
        .price-up { color: var(--success-color); }
        .price-down { color: var(--error-color); }
        .price-neutral { color: var(--neutral-color); }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--neutral-color);
            transition: color 0.2s ease, transform 0.2s ease;
            padding: 0;
            line-height: 1; /* Align star vertically */
            flex-shrink: 0;
        }
        .favorite-btn.favorited {
            color: gold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        .favorite-btn:hover {
            transform: scale(1.1);
        }


        /* Portfolio & History List Items */
        .portfolio-item, .history-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #444;
            font-size: 0.95em;
        }
        .portfolio-item:last-child, .history-item:last-child {
            border-bottom: none;
        }
        .portfolio-item div, .history-item div {
            margin-right: 15px;
            margin-bottom: 5px;
        }
        .profit-loss {
            font-weight: 700;
            margin-left: auto;
        }
        .profit { color: var(--success-color); }
        .loss { color: var(--error-color); }
        .buy-transaction { color: var(--success-color); }
        .sell-transaction { color: var(--error-color); }

        #no-portfolio-message, #no-history-message {
            color: var(--neutral-color);
            font-style: italic;
            margin-top: 15px;
            text-align: center;
        }
        
        #total-profit-loss-display { /* New CSS for total P/L */
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.4em;
            font-weight: 700;
            text-align: center;
            background-color: #3A3A50;
            border: 1px solid #444460;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }
        #total-profit-loss-display.profit-total {
            color: var(--success-color);
            border-color: var(--success-color);
        }
        #total-profit-loss-display.loss-total {
            color: var(--error-color);
            border-color: var(--error-color);
        }
        #total-profit-loss-display.neutral-total {
            color: var(--neutral-color);
            border-color: var(--neutral-color);
        }


        /* Popup Styles */
        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            border-radius: 18px;
            padding: 35px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.6);
            z-index: 1000;
            max-width: 650px;
            width: 90%;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid var(--primary-color);
            box-sizing: border-box;
            color: var(--text-color);
        }
        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }
        .popup-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 2.2em;
            font-weight: 700;
        }
        .popup-close {
            background: none;
            border: none;
            font-size: 2.5em;
            cursor: pointer;
            color: var(--neutral-color);
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .popup-close:hover {
            color: var(--error-color);
            transform: rotate(90deg);
        }
        .popup-content p {
            margin-bottom: 12px;
            font-size: 1.15em;
            color: var(--text-color);
        }
        .popup-content .current-price {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--primary-color);
        }
        .popup-content .remaining-stocks {
            font-size: 1.15em;
            color: var(--neutral-color);
        }

        #stock-chart-container {
            position: relative;
            height: 280px; /* Fixed height for the chart */
            width: 100%;
            margin-top: 25px;
            margin-bottom: 30px;
            background-color: #3A3A50;
            border: 1px solid #444460;
            border-radius: 10px;
            padding: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.15);
        }

        .action-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 25px;
            border-top: 1px solid #444;
            padding-top: 25px;
        }
        .buy-sell-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .action-section input[type="number"] {
            padding: 12px;
            border: 1px solid #666;
            background-color: #3A3A50;
            color: var(--text-color);
            border-radius: 8px;
            width: 120px;
            font-size: 1.1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .action-section input[type="number"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.2);
            outline: none;
        }
        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.15em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn:hover {
            background-color: #009ACD;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .btn.sell {
            background-color: var(--error-color);
        }
        .btn.sell:hover {
            background-color: #C0392B;
        }
        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .message-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.05em;
            text-align: center;
            animation: fadeIn 0.4s ease-out;
            display: none; /* Hidden by default */
        }
        .message-success {
            background-color: #285A36;
            color: #D4EDDA;
            border: 1px solid #367A47;
        }
        .message-error {
            background-color: #7A2E35;
            color: #F8D7DA;
            border: 1px solid #A13A43;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 999;
            backdrop-filter: blur(5px);
        }

        /* Login/Register Popup */
        #auth-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--card-bg) 0%, #2A2A3F 100%);
            border-radius: 18px;
            padding: 35px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.7);
            z-index: 1001; /* Higher than stock popup */
            max-width: 450px;
            width: 90%;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid var(--secondary-color);
            text-align: center;
        }
        #auth-popup h2 {
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 25px;
        }
        #auth-popup label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        #auth-popup input[type="text"],
        #auth-popup input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #666;
            background-color: #3A3A50;
            color: var(--text-color);
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #auth-popup input[type="text"]:focus,
        #auth-popup input[type="password"]:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(50, 205, 50, 0.2);
            outline: none;
        }
        #auth-popup .btn-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        #auth-popup .btn {
            width: 150px;
        }
        #auth-popup .toggle-auth {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1em;
            margin-top: 25px;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.3s ease;
        }
        #auth-popup .toggle-auth:hover {
            color: #009ACD;
        }

        #auth-message-area {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            font-weight: 500;
        }

        /* Notification styles */
        #notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
            pointer-events: none; /* Allows clicks to pass through */
        }

        .notification-item {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateX(100%);
            animation: slideInNotification 0.5s forwards, fadeOutNotification 0.5s 4.5s forwards;
            pointer-events: all; /* Make notification clickable */
            border-left: 5px solid var(--secondary-color);
        }

        @keyframes slideInNotification {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOutNotification {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }


        /* Responsive adjustments */
        @media (max-width: 1200px) {
            #main-content {
                padding: 20px;
                gap: 20px;
            }
            .tab-buttons {
                justify-content: center;
            }
            .tab-button {
                flex-grow: 0;
                width: 150px; /* Give a fixed width to buttons on smaller screens */
            }
        }

        @media (max-width: 768px) {
            #header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            #header h1 {
                font-size: 1.8em;
            }
            #balance-display, #account-pl-display {
                font-size: 1.2em;
            }
            .company-card {
                padding: 15px;
            }
            .company-name {
                font-size: 1.2em;
            }
            .stock-price {
                font-size: 1.2em;
            }
            .popup {
                padding: 25px;
            }
            .popup-header h3 {
                font-size: 1.8em;
            }
            #auth-popup {
                padding: 25px;
            }
            #notification-container {
                bottom: 10px;
                right: 10px;
                max-width: calc(100% - 20px);
            }
            .header-select-group {
                width: 100%;
                justify-content: center;
            }
            .header-select-group select {
                width: calc(50% - 15px); /* Adjust width for two selects */
            }
            #header-right {
                width: 100%;
                justify-content: center;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Infinity Trade Simulator</h1>
        <div id="header-right">
            <div id="user-info"></div>
            <div class="header-select-group">
                <label for="country-select">Market:</label>
                <select id="country-select" onchange="filterCompaniesByCountry()">
                    </select>
            </div>
            <div class="header-select-group">
                <label for="currency-select">Currency:</label>
                <select id="currency-select" onchange="updateCurrencyDisplay()">
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="GBP">GBP (£)</option>
                    <option value="JPY">JPY (¥)</option>
                    <option value="INR">INR (₹)</option>
                    <option value="CNY">CNY (¥)</option>
                    <option value="AUD">AUD (A$)</option>
                    <option value="LKR">LKR (Rs.)</option> </select>
            </div>
            <div id="balance-display">
                Balance: <span id="currency-symbol-balance">$</span><span id="user-balance">0.00</span>
            </div>
            <div id="account-pl-display">
                Account P/L: <span id="account-pl-value"></span>
            </div>
            <button id="login-btn" onclick="openAuthPopup('login')">Login / Register</button>
            <button id="logout-btn" style="display:none;" onclick="logout()">Logout</button>
            <button id="reset-account-btn" style="display:none;" onclick="resetAccount()">Reset Account</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div class="tabs-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="openTab('market-tab')">Market Overview</button>
                <button class="tab-button" onclick="openTab('portfolio-tab')">Your Portfolio</button>
                <button class="tab-button" onclick="openTab('history-tab')">Transaction History</button>
            </div>

            <div id="market-tab" class="tab-content active">
                <h2>Market Overview</h2>
                <div id="companies-grid">
                </div>
            </div>

            <div id="portfolio-tab" class="tab-content">
                <h2>Your Portfolio</h2>
                <div id="portfolio-list">
                    <p id="no-portfolio-message">You don't own any shares yet.</p>
                </div>
                <div id="total-profit-loss-display" style="display:none;">
                    Total P/L: <span id="currency-symbol-total-pl">$</span><span id="total-pl-value"></span>
                </div>
            </div>

            <div id="history-tab" class="tab-content">
                <h2>Transaction History</h2>
                <div id="history-list">
                    <p id="no-history-message">No transactions recorded yet.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="popup-overlay" class="overlay" onclick="closeAllPopups()"></div>

    <div id="stock-popup" class="popup">
        <div class="popup-header">
            <h3 id="popup-company-name"></h3>
            <button class="popup-close" onclick="closeAllPopups()">&times;</button>
        </div>
        <div class="popup-content">
            <p>Current Price: <span id="popup-currency-symbol">$</span><span id="popup-stock-price" class="current-price"></span></p>
            <p class="remaining-stocks">Stocks Available: <span id="popup-remaining-stocks"></span></p>

            <div id="stock-chart-container">
                <canvas id="stockChart"></canvas>
            </div>

            <div class="action-section">
                <div class="buy-sell-group">
                    <input type="number" id="buy-quantity" min="1" value="1" placeholder="Qty">
                    <button class="btn" id="buy-button" onclick="buyStocks()">Buy</button>
                </div>
                <div id="sell-group" class="buy-sell-group" style="display: none;">
                    <p>You own: <span id="popup-owned-stocks"></span> shares</p>
                    <input type="number" id="sell-quantity" min="1" value="1" placeholder="Qty">
                    <button class="btn sell" id="sell-button" onclick="sellStocks()">Sell</button>
                </div>
            </div>
            <div id="popup-message-area" class="message-area"></div>
        </div>
    </div>

    <div id="auth-popup" class="popup">
        <div class="popup-header">
            <h2 id="auth-title">Login</h2>
            <button class="popup-close" onclick="closeAllPopups()">&times;</button>
        </div>
        <form id="auth-form" onsubmit="event.preventDefault(); handleAuthSubmit();">
            <label for="username">Username:</label>
            <input type="text" id="username" required>
            <label for="password">Password:</label>
            <input type="password" id="password" required>
            <div class="btn-group">
                <button type="submit" class="btn" id="auth-submit-btn">Login</button>
            </div>
            <p id="auth-message-area" class="message-area"></p>
            <button type="button" class="toggle-auth" onclick="toggleAuthMode()">New user? Register here</button>
        </form>
    </div>

    <div id="notification-container"></div>
    <script>
        // --- Global Variables and Constants ---
        let userBalance = 0.00;
        const INITIAL_BALANCE = 10000.00;
        let currentUser = null;
        const PRICE_UPDATE_INTERVAL = 10000;
        const NOTIFICATION_INTERVAL = 20000;
        const MAX_HISTORY_POINTS = 20;

        // Expanded companies data with more countries and companies
let companies = [
    // USA - New York Stock Exchange (prices already in USD)
    { name: "Apple Inc.", symbol: "AAPL", price: 170.00, stocksRemaining: 1000, volatility: 0.015, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Microsoft Corp.", symbol: "MSFT", price: 420.00, stocksRemaining: 800, volatility: 0.012, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Alphabet Inc. (Google)", symbol: "GOOGL", price: 155.00, stocksRemaining: 1200, volatility: 0.018, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Amazon.com Inc.", symbol: "AMZN", price: 185.00, stocksRemaining: 900, volatility: 0.016, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "NVIDIA Corp.", symbol: "NVDA", price: 950.00, stocksRemaining: 300, volatility: 0.025, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Tesla Inc.", symbol: "TSLA", price: 175.00, stocksRemaining: 600, volatility: 0.028, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Meta Platforms Inc.", symbol: "META", price: 490.00, stocksRemaining: 700, volatility: 0.019, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Berkshire Hathaway Inc.", symbol: "BRK.B", price: 415.00, stocksRemaining: 500, volatility: 0.01, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Johnson & Johnson", symbol: "JNJ", price: 145.00, stocksRemaining: 1500, volatility: 0.008, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "JPMorgan Chase & Co.", symbol: "JPM", price: 195.00, stocksRemaining: 1100, volatility: 0.013, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Visa Inc.", symbol: "V", price: 275.00, stocksRemaining: 900, volatility: 0.014, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Procter & Gamble Co.", symbol: "PG", price: 160.00, stocksRemaining: 1300, volatility: 0.007, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Netflix Inc.", symbol: "NFLX", price: 650.00, stocksRemaining: 400, volatility: 0.020, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Costco Wholesale Corp.", symbol: "COST", price: 800.00, stocksRemaining: 350, volatility: 0.010, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Starbucks Corporation", symbol: "SBUX", price: 80.00, stocksRemaining: 1800, volatility: 0.013, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Nike, Inc.", symbol: "NKE", price: 95.00, stocksRemaining: 1500, volatility: 0.016, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Adobe Inc.", symbol: "ADBE", price: 500.00, stocksRemaining: 500, volatility: 0.017, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Salesforce, Inc.", symbol: "CRM", price: 250.00, stocksRemaining: 800, volatility: 0.019, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "PepsiCo, Inc.", symbol: "PEP", price: 170.00, stocksRemaining: 1000, volatility: 0.009, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Coca-Cola Company", symbol: "KO", price: 60.00, stocksRemaining: 2000, volatility: 0.008, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Walt Disney Company", symbol: "DIS", price: 100.00, stocksRemaining: 1300, volatility: 0.015, history: [], market: "New York Stock Exchange", currency: "USD" },
    { name: "Broadcom Inc.", symbol: "AVGO", price: 1400.00, stocksRemaining: 200, volatility: 0.024, history: [], market: "New York Stock Exchange", currency: "USD" },

    // India - National Stock Exchange of India (prices converted to USD)
    { name: "Reliance Industries", symbol: "RELI", price: (2800.00 * 0.012).toFixed(2), stocksRemaining: 700, volatility: 0.020, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "Tata Consultancy Services", symbol: "TCS", price: (3900.00 * 0.012).toFixed(2), stocksRemaining: 500, volatility: 0.015, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "Nestle India", symbol: "NESTLEIND", price: (2500.00 * 0.012).toFixed(2), stocksRemaining: 600, volatility: 0.010, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "HDFC Bank", symbol: "HDFCBANK", price: (1700.00 * 0.012).toFixed(2), stocksRemaining: 800, volatility: 0.012, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "Infosys", symbol: "INFY", price: (1500.00 * 0.012).toFixed(2), stocksRemaining: 900, volatility: 0.018, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "ICICI Bank", symbol: "ICICIBANK", price: (1100.00 * 0.012).toFixed(2), stocksRemaining: 950, volatility: 0.014, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "State Bank of India", symbol: "SBIN", price: (750.00 * 0.012).toFixed(2), stocksRemaining: 1200, volatility: 0.010, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "Axis Bank", symbol: "AXISBANK", price: (1050.00 * 0.012).toFixed(2), stocksRemaining: 800, volatility: 0.016, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "Larsen & Toubro", symbol: "LT", price: (3500.00 * 0.012).toFixed(2), stocksRemaining: 600, volatility: 0.017, history: [], market: "National Stock Exchange of India", currency: "USD" },
    { name: "Wipro", symbol: "WIPRO", price: (500.00 * 0.012).toFixed(2), stocksRemaining: 1100, volatility: 0.019, history: [], market: "National Stock Exchange of India", currency: "USD" },

    // Japan - Tokyo Stock Exchange (prices converted to USD)
    { name: "Toyota Motor Corp.", symbol: "TM", price: (250.00 * 0.0069).toFixed(2), stocksRemaining: 900, volatility: 0.012, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "Sony Group Corp.", symbol: "SONY", price: (85.00 * 0.0069).toFixed(2), stocksRemaining: 1100, volatility: 0.018, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "Honda Motor Co.", symbol: "HMC", price: (38.00 * 0.0069).toFixed(2), stocksRemaining: 1500, volatility: 0.015, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "SoftBank Group", symbol: "SFTBY", price: (25.00 * 0.0069).toFixed(2), stocksRemaining: 1000, volatility: 0.020, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "Mitsubishi UFJ Financial Group", symbol: "MUFG", price: (12.00 * 0.0069).toFixed(2), stocksRemaining: 2000, volatility: 0.010, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "Keyence Corp.", symbol: "KYCCF", price: (450.00 * 0.0069).toFixed(2), stocksRemaining: 300, volatility: 0.021, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "Nintendo Co., Ltd.", symbol: "NTDOY", price: (15.00 * 0.0069).toFixed(2), stocksRemaining: 1800, volatility: 0.019, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "Hitachi Ltd.", symbol: "HTHIY", price: (120.00 * 0.0069).toFixed(2), stocksRemaining: 700, volatility: 0.014, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "Canon Inc.", symbol: "CAJ", price: (30.00 * 0.0069).toFixed(2), stocksRemaining: 1400, volatility: 0.013, history: [], market: "Tokyo Stock Exchange", currency: "USD" },
    { name: "Panasonic Holdings Corp.", symbol: "PCRFY", price: (10.00 * 0.0069).toFixed(2), stocksRemaining: 1600, volatility: 0.016, history: [], market: "Tokyo Stock Exchange", currency: "USD" },

    // South Korea - Korea Exchange (prices converted to USD)
    { name: "Samsung Electronics", symbol: "SMSN", price: (75000.00 * 0.00072).toFixed(2), stocksRemaining: 1500, volatility: 0.020, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "Hyundai Motor Co.", symbol: "HYMLF", price: (45000.00 * 0.00072).toFixed(2), stocksRemaining: 1200, volatility: 0.017, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "SK Hynix", symbol: "SKHY", price: (180000.00 * 0.00072).toFixed(2), stocksRemaining: 800, volatility: 0.025, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "LG Chem", symbol: "LGCLF", price: (400000.00 * 0.00072).toFixed(2), stocksRemaining: 300, volatility: 0.022, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "POSCO", symbol: "PKX", price: (300000.00 * 0.00072).toFixed(2), stocksRemaining: 500, volatility: 0.018, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "Kakao Corp.", symbol: "KCAOF", price: (50000.00 * 0.00072).toFixed(2), stocksRemaining: 1000, volatility: 0.023, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "Naver Corp.", symbol: "NHNCF", price: (180000.00 * 0.00072).toFixed(2), stocksRemaining: 700, volatility: 0.021, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "Samsung SDI", symbol: "SSDIY", price: (480000.00 * 0.00072).toFixed(2), stocksRemaining: 250, volatility: 0.026, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "Shinhan Financial Group", symbol: "SHG", price: (40000.00 * 0.00072).toFixed(2), stocksRemaining: 1100, volatility: 0.015, history: [], market: "Korea Exchange", currency: "USD" },
    { name: "KB Financial Group", symbol: "KB", price: (70000.00 * 0.00072).toFixed(2), stocksRemaining: 900, volatility: 0.014, history: [], market: "Korea Exchange", currency: "USD" },

    // China - Shanghai Stock Exchange (prices converted to USD)
    { name: "Tencent Holdings", symbol: "TCEHY", price: (350.00 * 0.14).toFixed(2), stocksRemaining: 800, volatility: 0.022, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "Alibaba Group", symbol: "BABA", price: (75.00 * 0.14).toFixed(2), stocksRemaining: 1000, volatility: 0.023, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "JD.com Inc.", symbol: "JD", price: (30.00 * 0.14).toFixed(2), stocksRemaining: 1100, volatility: 0.021, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "Industrial and Commercial Bank of China", symbol: "IDCBY", price: (5.00 * 0.14).toFixed(2), stocksRemaining: 5000, volatility: 0.005, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "China Construction Bank", symbol: "CICHY", price: (6.00 * 0.14).toFixed(2), stocksRemaining: 4500, volatility: 0.006, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "Ping An Insurance", symbol: "PNGAY", price: (60.00 * 0.14).toFixed(2), stocksRemaining: 1200, volatility: 0.015, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "Kweichow Moutai", symbol: "600519.SS", price: (1700.00 * 0.14).toFixed(2), stocksRemaining: 100, volatility: 0.028, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "BYD Co.", symbol: "BYDDY", price: (30.00 * 0.14).toFixed(2), stocksRemaining: 900, volatility: 0.020, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "PetroChina Co. Ltd.", symbol: "PCCYF", price: (5.00 * 0.14).toFixed(2), stocksRemaining: 3000, volatility: 0.010, history: [], market: "Shanghai Stock Exchange", currency: "USD" },
    { name: "Agricultural Bank of China", symbol: "ACGBY", price: (4.00 * 0.14).toFixed(2), stocksRemaining: 4800, volatility: 0.007, history: [], market: "Shanghai Stock Exchange", currency: "USD" },

    // UK - London Stock Exchange (prices converted to USD)
    { name: "Unilever PLC", symbol: "UL", price: (50.00 * 1.35).toFixed(2), stocksRemaining: 1000, volatility: 0.011, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "HSBC Holdings", symbol: "HSBC", price: (40.00 * 1.35).toFixed(2), stocksRemaining: 1200, volatility: 0.013, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "BP p.l.c.", symbol: "BP", price: (5.00 * 1.35).toFixed(2), stocksRemaining: 2500, volatility: 0.015, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "Shell plc", symbol: "SHEL", price: (25.00 * 1.35).toFixed(2), stocksRemaining: 1800, volatility: 0.016, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "AstraZeneca PLC", symbol: "AZN", price: (120.00 * 1.35).toFixed(2), stocksRemaining: 700, volatility: 0.018, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "GlaxoSmithKline plc (GSK)", symbol: "GSK", price: (16.00 * 1.35).toFixed(2), stocksRemaining: 1500, volatility: 0.012, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "Rio Tinto Group", symbol: "RIO", price: (60.00 * 1.35).toFixed(2), stocksRemaining: 900, volatility: 0.020, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "Barclays PLC", symbol: "BCS", price: (2.00 * 1.35).toFixed(2), stocksRemaining: 3000, volatility: 0.014, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "Lloyds Banking Group plc", symbol: "LLOY", price: (0.50 * 1.35).toFixed(2), stocksRemaining: 5000, volatility: 0.009, history: [], market: "London Stock Exchange", currency: "USD" },
    { name: "Vodafone Group Plc", symbol: "VOD", price: (0.80 * 1.35).toFixed(2), stocksRemaining: 4000, volatility: 0.010, history: [], market: "London Stock Exchange", currency: "USD" },

    // Germany - Frankfurt Stock Exchange (prices converted to USD)
    { name: "SAP SE", symbol: "SAP", price: (180.00 * 1.13).toFixed(2), stocksRemaining: 700, volatility: 0.016, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "Siemens AG", symbol: "SIEGY", price: (190.00 * 1.13).toFixed(2), stocksRemaining: 800, volatility: 0.014, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "Volkswagen AG", symbol: "VWAGY", price: (120.00 * 1.13).toFixed(2), stocksRemaining: 900, volatility: 0.019, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "Mercedes-Benz Group AG", symbol: "MBGAF", price: (70.00 * 1.13).toFixed(2), stocksRemaining: 1100, volatility: 0.017, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "BMW AG", symbol: "BMWYY", price: (100.00 * 1.13).toFixed(2), stocksRemaining: 1000, volatility: 0.018, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "Allianz SE", symbol: "ALV.DE", price: (250.00 * 1.13).toFixed(2), stocksRemaining: 600, volatility: 0.010, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "Deutsche Telekom AG", symbol: "DTEGY", price: (25.00 * 1.13).toFixed(2), stocksRemaining: 1500, volatility: 0.012, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "BASF SE", symbol: "BASFY", price: (50.00 * 1.13).toFixed(2), stocksRemaining: 1300, volatility: 0.015, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "Bayer AG", symbol: "BAYRY", price: (30.00 * 1.13).toFixed(2), stocksRemaining: 1400, volatility: 0.020, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },
    { name: "Adidas AG", symbol: "ADDYY", price: (200.00 * 1.13).toFixed(2), stocksRemaining: 500, volatility: 0.021, history: [], market: "Frankfurt Stock Exchange", currency: "USD" },

    // France - Euronext Paris (prices converted to USD)
    { name: "LVMH Moët Hennessy Louis Vuitton", symbol: "LVMUY", price: (800.00 * 1.13).toFixed(2), stocksRemaining: 200, volatility: 0.019, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "TotalEnergies SE", symbol: "TTE", price: (65.00 * 1.13).toFixed(2), stocksRemaining: 900, volatility: 0.017, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "L'Oréal S.A.", symbol: "LRLCY", price: (400.00 * 1.13).toFixed(2), stocksRemaining: 300, volatility: 0.015, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "Hermès International", symbol: "HESAF", price: (2000.00 * 1.13).toFixed(2), stocksRemaining: 100, volatility: 0.025, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "Sanofi S.A.", symbol: "SNY", price: (90.00 * 1.13).toFixed(2), stocksRemaining: 800, volatility: 0.011, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "BNP Paribas SA", symbol: "BNPQF", price: (60.00 * 1.13).toFixed(2), stocksRemaining: 1200, volatility: 0.013, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "Schneider Electric SE", symbol: "SBGSY", price: (220.00 * 1.13).toFixed(2), stocksRemaining: 600, volatility: 0.016, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "Air Liquide S.A.", symbol: "AIQUY", price: (180.00 * 1.13).toFixed(2), stocksRemaining: 700, volatility: 0.012, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "Airbus SE", symbol: "EADSY", price: (150.00 * 1.13).toFixed(2), stocksRemaining: 800, volatility: 0.020, history: [], market: "Euronext Paris", currency: "USD" },
    { name: "AXA S.A.", symbol: "AXAHY", price: (30.00 * 1.13).toFixed(2), stocksRemaining: 1000, volatility: 0.010, history: [], market: "Euronext Paris", currency: "USD" },

    // Canada - Toronto Stock Exchange (prices converted to USD)
    { name: "Shopify Inc.", symbol: "SHOP", price: (70.00 * 0.73).toFixed(2), stocksRemaining: 600, volatility: 0.025, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Royal Bank of Canada", symbol: "RY", price: (130.00 * 0.73).toFixed(2), stocksRemaining: 800, volatility: 0.010, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Toronto-Dominion Bank", symbol: "TD", price: (85.00 * 0.73).toFixed(2), stocksRemaining: 900, volatility: 0.011, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Enbridge Inc.", symbol: "ENB", price: (50.00 * 0.73).toFixed(2), stocksRemaining: 1100, volatility: 0.014, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Bank of Nova Scotia", symbol: "BNS", price: (70.00 * 0.73).toFixed(2), stocksRemaining: 1000, volatility: 0.012, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Canadian National Railway", symbol: "CNI", price: (150.00 * 0.73).toFixed(2), stocksRemaining: 700, volatility: 0.016, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Barrick Gold Corp.", symbol: "GOLD", price: (20.00 * 0.73).toFixed(2), stocksRemaining: 1500, volatility: 0.020, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Nutrien Ltd.", symbol: "NTR", price: (60.00 * 0.73).toFixed(2), stocksRemaining: 950, volatility: 0.017, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Manulife Financial Corp.", symbol: "MFC", price: (28.00 * 0.73).toFixed(2), stocksRemaining: 1200, volatility: 0.013, history: [], market: "Toronto Stock Exchange", currency: "USD" },
    { name: "Cenovus Energy Inc.", symbol: "CVE", price: (25.00 * 0.73).toFixed(2), stocksRemaining: 1300, volatility: 0.022, history: [], market: "Toronto Stock Exchange", currency: "USD" },

    // Australia - Australian Securities Exchange (prices converted to USD)
    { name: "BHP Group", symbol: "BHP", price: (45.00 * 0.64).toFixed(2), stocksRemaining: 1000, volatility: 0.018, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "Commonwealth Bank", symbol: "CBA", price: (120.00 * 0.64).toFixed(2), stocksRemaining: 700, volatility: 0.012, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "National Australia Bank", symbol: "NAB", price: (35.00 * 0.64).toFixed(2), stocksRemaining: 1100, volatility: 0.010, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "Westpac Banking Corp.", symbol: "WBC", price: (25.00 * 0.64).toFixed(2), stocksRemaining: 1200, volatility: 0.011, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "ANZ Group Holdings", symbol: "ANZ", price: (28.00 * 0.64).toFixed(2), stocksRemaining: 1050, volatility: 0.013, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "Fortescue Metals Group", symbol: "FMG", price: (20.00 * 0.64).toFixed(2), stocksRemaining: 900, volatility: 0.020, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "Woodside Energy Group", symbol: "WDS", price: (30.00 * 0.64).toFixed(2), stocksRemaining: 800, volatility: 0.017, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "Woolworths Group", symbol: "WOW", price: (38.00 * 0.64).toFixed(2), stocksRemaining: 1300, volatility: 0.009, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "Wesfarmers Ltd.", symbol: "WES", price: (60.00 * 0.64).toFixed(2), stocksRemaining: 700, volatility: 0.015, history: [], market: "Australian Securities Exchange", currency: "USD" },
    { name: "Macquarie Group Ltd.", symbol: "MQG", price: (190.00 * 0.64).toFixed(2), stocksRemaining: 400, volatility: 0.019, history: [], market: "Australian Securities Exchange", currency: "USD" },

    // Sri Lanka - Colombo Stock Exchange (prices converted to USD)
  { name: "John Keells Holdings PLC", symbol: "JKH.N0000", price: (210.00 * 0.0033).toFixed(2), stocksRemaining: 1000, volatility: 0.019, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "LOLC Holdings PLC", symbol: "LOLC.N0000", price: (623.00 * 0.0033).toFixed(2), stocksRemaining: 700, volatility: 0.025, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Commercial Bank of Ceylon PLC", symbol: "COMB.N0000", price: (148.25 * 0.0033).toFixed(2), stocksRemaining: 1200, volatility: 0.015, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Hatton National Bank PLC", symbol: "HNB.N0000", price: (214.00 * 0.0033).toFixed(2), stocksRemaining: 1100, volatility: 0.016, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Dialog Axiata PLC", symbol: "DIAL.N0000", price: (17.60 * 0.0033).toFixed(2), stocksRemaining: 1500, volatility: 0.020, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Nestle Lanka PLC", symbol: "NEST.N0000", price: (1120.00 * 0.0033).toFixed(2), stocksRemaining: 400, volatility: 0.010, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Sri Lanka Telecom PLC", symbol: "SLTL.N0000", price: (63.00 * 0.0033).toFixed(2), stocksRemaining: 1300, volatility: 0.018, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Expolanka Holdings PLC", symbol: "EXPO.N0000", price: (151.00 * 0.0033).toFixed(2), stocksRemaining: 800, volatility: 0.028, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Sampath Bank PLC", symbol: "SAMP.N0000", price: (115.50 * 0.0033).toFixed(2), stocksRemaining: 1000, volatility: 0.017, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Browns Investments PLC", symbol: "BIL.N0000", price: (8.20 * 0.0033).toFixed(2), stocksRemaining: 1800, volatility: 0.022, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Hayleys PLC", symbol: "HAYL.N0000", price: (137.00 * 0.0033).toFixed(2), stocksRemaining: 900, volatility: 0.020, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Access Engineering PLC", symbol: "AEL.N0000", price: (38.20 * 0.0033).toFixed(2), stocksRemaining: 1200, volatility: 0.019, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Vallibel One PLC", symbol: "VONE.N0000", price: (71.60 * 0.0033).toFixed(2), stocksRemaining: 850, volatility: 0.021, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Bukit Darah PLC", symbol: "BUKI.N0000", price: (414.75 * 0.0033).toFixed(2), stocksRemaining: 500, volatility: 0.012, history: [], market: "Colombo Stock Exchange", currency: "USD" },
    { name: "Carson Cumberbatch PLC", symbol: "CARS.N0000", price: (288.00 * 0.0033).toFixed(2), stocksRemaining: 600, volatility: 0.014, history: [], market: "Colombo Stock Exchange", currency: "USD" }

];

        let portfolio = {};
        let transactionHistory = [];
        let favoriteCompanies = [];
        let usersData = JSON.parse(localStorage.getItem('users') || '{}');

        // New variables for country and currency
        let selectedMarket = 'All'; // Default to show all companies
        let selectedCurrency = 'USD'; // Default display currency

        const currencyExchangeRates = {
            "USD": 1.00, // Base currency
            "EUR": 0.92,
            "GBP": 0.79,
            "JPY": 156.70,
            "INR": 83.40,
            "CNY": 7.25,
            "AUD": 1.50,
            "CAD": 1.37,
            "KRW": 1378.00,
            "LKR": 305.00 // Added LKR Exchange Rate
        };

        const currencySymbols = {
            "USD": "$",
            "EUR": "€",
            "GBP": "£",
            "JPY": "¥",
            "INR": "₹",
            "CNY": "¥",
            "AUD": "A$",
            "CAD": "C$",
            "KRW": "₩",
            "LKR": "Rs." // Added LKR Symbol
        };


        const userBalanceSpan = document.getElementById('user-balance');
        const accountPLValueSpan = document.getElementById('account-pl-value');
        const companiesGridDiv = document.getElementById('companies-grid');
        const stockPopup = document.getElementById('stock-popup');
        const popupOverlay = document.getElementById('popup-overlay');
        const popupCompanyName = document.getElementById('popup-company-name');
        const popupRemainingStocks = document.getElementById('popup-remaining-stocks');
        const popupStockPrice = document.getElementById('popup-stock-price');
        const buyQuantityInput = document.getElementById('buy-quantity');
        const buyButton = document.getElementById('buy-button');
        const sellGroup = document.getElementById('sell-group');
        const popupOwnedStocks = document.getElementById('popup-owned-stocks');
        const sellQuantityInput = document.getElementById('sell-quantity');
        const portfolioListDiv = document.getElementById('portfolio-list');
        const noPortfolioMessage = document.getElementById('no-portfolio-message');
        const totalProfitLossDisplay = document.getElementById('total-profit-loss-display');
        const totalPLValueSpan = document.getElementById('total-pl-value');
        const historyListDiv = document.getElementById('history-list');
        const noHistoryMessage = document.getElementById('no-history-message');
        const popupMessageArea = document.getElementById('popup-message-area');
        const userInfoSpan = document.getElementById('user-info');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const resetAccountBtn = document.getElementById('reset-account-btn');
        const mainContentDiv = document.getElementById('main-content');
        const authPopup = document.getElementById('auth-popup');
        const authTitle = document.getElementById('auth-title');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authMessageArea = document.getElementById('auth-message-area');
        const notificationContainer = document.getElementById('notification-container');
        const countrySelect = document.getElementById('country-select'); // Renamed to countrySelect, but now holds market names
        const currencySelect = document.getElementById('currency-select');
        const currencySymbolBalance = document.getElementById('currency-symbol-balance');
        const currencySymbolTotalPL = document.getElementById('currency-symbol-total-pl');
        const popupCurrencySymbol = document.getElementById('popup-currency-symbol');


        let isRegisterMode = false;
        let currentCompanySymbol = null;
        let stockChart;
        let priceUpdateIntervalId;
        let notificationIntervalId;
        const miniCharts = {};

        const newsMessages = [
            "Global market volatility expected next week.",
            "Tech sector in New York Stock Exchange shows strong growth, analysts predict further gains.",
            "Energy prices fluctuate amid global supply concerns.",
            "Healthcare innovations in Europe driving new investment opportunities.",
            "Consumer spending in Asia remains robust, boosting retail stocks.",
            "Interest rate hike anticipated in New York, bond markets react.",
            "Manufacturing output in China beats expectations, positive outlook for industrials.",
            "Global trade tensions ease, bringing relief to commodity markets.",
            "New AI advancements creating buzz in the semiconductor industry worldwide.",
            "Real estate market in India stabilizes after recent corrections.",
            "EU announces new environmental policies, impacting heavy industries.",
            "Japanese Yen strengthens against USD, affecting export companies.",
            "Australian mining sector sees strong demand for key minerals.",
            "Canadian tech startups receive significant venture capital funding.",
            "South Korean electronics giants report record profits.",
            "Colombo Stock Exchange sees increased foreign direct investment." // Added LKR specific news
        ];

        // --- ADDED: Functions to save and load company market data ---
        function saveCompanyData() {
            const companyDataToSave = companies.map(company => ({
                symbol: company.symbol,
                price: company.price,
                history: company.history,
                stocksRemaining: company.stocksRemaining
            }));
            localStorage.setItem('companyMarketData', JSON.stringify(companyDataToSave));
        }

        function loadCompanyData() {
            const savedCompanyData = JSON.parse(localStorage.getItem('companyMarketData'));
            if (savedCompanyData) {
                companies.forEach(company => {
                    const savedData = savedCompanyData.find(s => s.symbol === company.symbol);
                    if (savedData) {
                        company.price = savedData.price;
                        // Ensure history is an array and not empty; if loaded history is bad, start fresh for that stock
                        company.history = (Array.isArray(savedData.history) && savedData.history.length > 0) ? savedData.history : [savedData.price];
                        // Ensure history doesn't exceed max points after loading
                        if (company.history.length > MAX_HISTORY_POINTS) {
                            company.history = company.history.slice(-MAX_HISTORY_POINTS);
                        }
                        company.stocksRemaining = savedData.stocksRemaining !== undefined ? savedData.stocksRemaining : company.stocksRemaining;
                    } else {
                        // If a company in the script is not in saved data (e.g., new company added), initialize its history
                        company.history = [company.price];
                    }
                });
            } else {
                // If no saved data at all, initialize history for all companies
                companies.forEach(company => {
                    company.history = [company.price];
                });
            }
        }
        // --- END ADDED ---

        // --- Local Storage Functions ---
        function saveUserData() {
            if (currentUser) {
                usersData[currentUser] = {
                    password: usersData[currentUser].password,
                    balance: userBalance,
                    portfolio: portfolio,
                    history: transactionHistory,
                    favorites: favoriteCompanies,
                    selectedCurrency: selectedCurrency // Save user's selected currency
                };
                localStorage.setItem('users', JSON.stringify(usersData));
            }
        }

        function loadUserData() {
            if (currentUser && usersData[currentUser]) {
                const userData = usersData[currentUser];
                userBalance = userData.balance !== undefined ? userData.balance : INITIAL_BALANCE;
                portfolio = userData.portfolio || {};
                transactionHistory = userData.history || [];
                favoriteCompanies = userData.favorites || [];
                selectedCurrency = userData.selectedCurrency || 'USD'; // Load user's selected currency
                currencySelect.value = selectedCurrency; // Set the dropdown
            } else {
                userBalance = INITIAL_BALANCE;
                portfolio = {};
                transactionHistory = [];
                favoriteCompanies = [];
                selectedCurrency = 'USD'; // Reset to default if no user or data
                currencySelect.value = selectedCurrency;
            }
            updateCurrencyDisplay(); // Update display after loading user data
            updateBalanceDisplay();
            updateAccountPLDisplay();
            updatePortfolioDisplay();
            updateHistoryDisplay();
        }

        // --- UI Update Functions ---
        function getConvertedValue(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            const usdValue = amount / (currencyExchangeRates[fromCurrency] || 1);
            return usdValue * (currencyExchangeRates[toCurrency] || 1);
        }

        function formatCurrency(amount, currency) {
            const symbol = currencySymbols[currency] || '$';
            return `${symbol}${amount.toFixed(2)}`;
        }

        function updateCurrencyDisplay() {
            const currentCurrencySymbol = currencySymbols[selectedCurrency] || '$';
            currencySymbolBalance.textContent = currentCurrencySymbol;
            currencySymbolTotalPL.textContent = currentCurrencySymbol;
            popupCurrencySymbol.textContent = currentCurrencySymbol;

            updateBalanceDisplay();
            updateAccountPLDisplay();
            updatePortfolioDisplay();
            renderCompanies(); // Re-render companies to update their displayed prices
            // No need to update history display directly, as it uses stored USD values and adds conversion on the fly.
        }

        function updateBalanceDisplay() {
            const convertedBalance = getConvertedValue(userBalance, "USD", selectedCurrency);
            userBalanceSpan.textContent = convertedBalance.toFixed(2);
        }

        function updateAccountPLDisplay() {
            let totalPortfolioValueUSD = 0;
            for (const symbol in portfolio) {
                const item = portfolio[symbol];
                const company = companies.find(c => c.symbol === symbol);
                if (company) {
                    // Always calculate based on the stock's native currency (USD for now, or company.currency if implemented)
                    // Convert company.price from its native currency to USD for this calculation
                    const companyPriceInUSD = getConvertedValue(company.price, company.currency, "USD");
                    totalPortfolioValueUSD += item.quantity * companyPriceInUSD;
                }
            }

            // Total invested needs to be in USD as purchases are recorded in USD
            // purchasePrice is already stored in USD as per buyStocks logic
            const totalInvestedUSD = Object.values(portfolio).reduce((sum, item) => sum + (item.quantity * item.purchasePrice), 0);
            const accountProfitLossUSD = (userBalance + totalPortfolioValueUSD) - (INITIAL_BALANCE + totalInvestedUSD);

            const convertedAccountProfitLoss = getConvertedValue(accountProfitLossUSD, "USD", selectedCurrency);

            accountPLValueSpan.textContent = `${convertedAccountProfitLoss >= 0 ? '+' : ''}${convertedAccountProfitLoss.toFixed(2)}`;
            accountPLValueSpan.className = ''; // Clear existing classes
            if (convertedAccountProfitLoss > 0) {
                accountPLValueSpan.classList.add('profit');
            } else if (convertedAccountProfitLoss < 0) {
                accountPLValueSpan.classList.add('loss');
            } else {
                accountPLValueSpan.classList.add('neutral');
            }
        }


        function displayPopupMessage(message, isError = false) {
            popupMessageArea.textContent = message;
            popupMessageArea.classList.remove('message-success', 'message-error');
            if (isError) {
                popupMessageArea.classList.add('message-error');
            } else {
                popupMessageArea.classList.add('message-success');
            }
            popupMessageArea.style.display = 'block';
            setTimeout(() => {
                popupMessageArea.style.display = 'none';
            }, 3000);
        }

        function displayAuthMessage(message, isError = false) {
            authMessageArea.textContent = message;
            authMessageArea.classList.remove('message-success', 'message-error');
            if (isError) {
                authMessageArea.classList.add('message-error');
            } else {
                authMessageArea.classList.add('message-success');
            }
            authMessageArea.style.display = 'block';
            setTimeout(() => {
                authMessageArea.style.display = 'none';
            }, 3000);
        }

        function showNotification(message) {
            const notificationItem = document.createElement('div');
            notificationItem.classList.add('notification-item');
            notificationItem.textContent = message;
            notificationContainer.appendChild(notificationItem);

            setTimeout(() => {
                notificationItem.remove();
            }, 5000);
        }

        // --- Core Game Logic Functions ---
        function generateNewPrice(currentPrice, volatility) {
            const factor = (Math.random() * 2 - 1) * volatility * 0.5;
            let newPrice = currentPrice * (1 + factor);
            // Ensure price doesn't go below a reasonable minimum, e.g., 0.01 for USD or equivalent
            // This adjustment might need to be smarter per currency if minimums are critical
            if (newPrice < 0.01) newPrice = 0.01 + Math.random() * 0.01;
            return parseFloat(newPrice.toFixed(2));
        }

        function updateAllStockPrices() {
            companies.forEach(company => {
                const oldPrice = company.price;
                company.price = generateNewPrice(company.price, company.volatility);

                company.history.push(company.price);
                if (company.history.length > MAX_HISTORY_POINTS) {
                    company.history.shift();
                }

                // Only update visible cards to avoid errors for filtered out companies
                const card = document.querySelector(`.company-card[data-symbol="${company.symbol}"]`);
                if (card) {
                    const priceSpan = card.querySelector('.stock-price-value');
                    const changeSpan = card.querySelector('.price-change');
                    const diff = company.price - oldPrice; // Diff in company's native currency

                    // Convert prices and diff to selected display currency
                    const displayedPrice = getConvertedValue(company.price, company.currency, selectedCurrency);
                    const displayedDiff = getConvertedValue(diff, company.currency, selectedCurrency);

                    priceSpan.textContent = displayedPrice.toFixed(2);
                    changeSpan.textContent = `${displayedDiff >= 0 ? '+' : ''}${displayedDiff.toFixed(2)}`;
                    changeSpan.classList.remove('price-up', 'price-down', 'price-neutral');
                    if (displayedDiff > 0) changeSpan.classList.add('price-up');
                    else if (displayedDiff < 0) changeSpan.classList.add('price-down');
                    else changeSpan.classList.add('price-neutral');
                }

                if (currentCompanySymbol === company.symbol && stockPopup.style.display === 'block') {
                    popupStockPrice.textContent = getConvertedValue(company.price, company.currency, selectedCurrency).toFixed(2);
                    updateStockChart(company);
                }
            });
            updatePortfolioDisplay();
            updateAccountPLDisplay();
            saveCompanyData();
        }

        // Helper to populate market dropdown
        function populateMarketSelect() {
            const markets = new Set(companies.map(c => c.market));
            countrySelect.innerHTML = '<option value="All">All Markets</option>'; // Renamed element to countrySelect in HTML, but logic here is for markets
            markets.forEach(market => {
                const option = document.createElement('option');
                option.value = market;
                option.textContent = market;
                countrySelect.appendChild(option);
            });
            // Set selected market if previously saved or default
            countrySelect.value = selectedMarket;
        }

        function filterCompaniesByCountry() { // Function name remains for continuity, but filters by market
            selectedMarket = countrySelect.value;
            renderCompanies();
        }

        function renderCompanies() {
            companiesGridDiv.innerHTML = '';
            const filteredCompanies = companies.filter(company =>
                selectedMarket === 'All' || company.market === selectedMarket
            );

            const sortedCompanies = [...filteredCompanies].sort((a, b) => {
                const aIsFavorite = favoriteCompanies.includes(a.symbol);
                const bIsFavorite = favoriteCompanies.includes(b.symbol);
                if (aIsFavorite && !bIsFavorite) return -1;
                if (!aIsFavorite && bIsFavorite) return 1;
                return a.name.localeCompare(b.name);
            });

            sortedCompanies.forEach(company => {
                const companyCard = document.createElement('div');
                companyCard.classList.add('company-card');
                companyCard.dataset.symbol = company.symbol;

                // Ensure history has at least one point for diff calculation
                if (!company.history || company.history.length === 0) company.history = [company.price];
                
                const prevPrice = company.history.length > 1 ? company.history[company.history.length - 2] : company.price;
                const diff = company.price - prevPrice; // Diff in company's native currency

                // Convert prices and diff to selected display currency
                const displayedPrice = getConvertedValue(company.price, company.currency, selectedCurrency);
                const displayedDiff = getConvertedValue(diff, company.currency, selectedCurrency);

                let priceChangeClass = 'price-neutral';
                if (displayedDiff > 0.001) priceChangeClass = 'price-up'; // Add small epsilon for floating point
                else if (displayedDiff < -0.001) priceChangeClass = 'price-down';

                const priceChangeText = `${displayedDiff >= 0 ? '+' : ''}${displayedDiff.toFixed(2)}`;
                const isFavorited = favoriteCompanies.includes(company.symbol);

                companyCard.innerHTML = `
                    <div class="company-header">
                        <div class="company-name">${company.name}</div>
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite('${company.symbol}')">★</button>
                    </div>
                    <div class="company-symbol">${company.symbol}</div>
                    <div class="company-country">${company.market}</div> <div class="company-details">
                        Stocks Available: ${company.stocksRemaining}<br>
                        Price: ${currencySymbols[selectedCurrency] || '$'}<span class="stock-price stock-price-value">${displayedPrice.toFixed(2)}</span>
                        <span class="price-change ${priceChangeClass}">${priceChangeText}</span>
                    </div>
                    <div class="mini-chart-container" style="height: 60px; width: 100%; margin-top: 10px;">
                        <canvas id="miniChart-${company.symbol}"></canvas>
                    </div>
                `;
                companyCard.onclick = () => openStockPopup(company.symbol);
                companiesGridDiv.appendChild(companyCard);
                renderMiniChart(company); // Render mini chart even if not visible
            });
        }

        function toggleFavorite(symbol) {
            if (!currentUser) {
                openAuthPopup('login');
                displayAuthMessage("Please log in to manage favorites.", true);
                return;
            }
            const index = favoriteCompanies.indexOf(symbol);
            if (index > -1) favoriteCompanies.splice(index, 1);
            else favoriteCompanies.push(symbol);
            saveUserData();
            renderCompanies();
        }

        function openStockPopup(symbol) {
            if (!currentUser) {
                openAuthPopup('login');
                displayAuthMessage("Please log in to trade stocks.", true);
                return;
            }
            currentCompanySymbol = symbol;
            const company = companies.find(c => c.symbol === symbol);
            if (!company) return;

            const displayedPrice = getConvertedValue(company.price, company.currency, selectedCurrency); // Convert company's native price to selected display currency

            popupCompanyName.textContent = company.name;
            popupRemainingStocks.textContent = company.stocksRemaining;
            popupStockPrice.textContent = displayedPrice.toFixed(2);
            buyQuantityInput.value = 1;

            if (portfolio[symbol] && portfolio[symbol].quantity > 0) {
                sellGroup.style.display = 'flex';
                popupOwnedStocks.textContent = portfolio[symbol].quantity;
                sellQuantityInput.max = portfolio[symbol].quantity;
                sellQuantityInput.value = 1;
            } else {
                sellGroup.style.display = 'none';
            }
            stockPopup.style.display = 'block';
            popupOverlay.style.display = 'block';
            renderStockChart(company);
        }

        function closeAllPopups() {
            stockPopup.style.display = 'none';
            authPopup.style.display = 'none';
            popupOverlay.style.display = 'none';
            currentCompanySymbol = null;
            if (stockChart) {
                stockChart.destroy();
                stockChart = null;
            }
            popupMessageArea.style.display = 'none';
            authMessageArea.style.display = 'none';
            usernameInput.value = '';
            passwordInput.value = '';
        }

        function renderMiniChart(company) {
            const canvas = document.getElementById(`miniChart-${company.symbol}`);
            if (!canvas) return; // Skip if element is not in the current view (e.g. filtered by market)
            const ctx = canvas.getContext('2d');
            if (miniCharts[company.symbol]) miniCharts[company.symbol].destroy();

            // Convert history data for mini chart from company's native currency to selected display currency
            const data = (company.history && company.history.length > 0 ? company.history : [company.price])
                .map(price => getConvertedValue(price, company.currency, selectedCurrency));

            miniCharts[company.symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(data.length).fill(''),
                    datasets: [{
                        data: data,
                        borderColor: varToRgba('--primary-color', 0.8),
                        backgroundColor: varToRgba('--primary-color', 0.1),
                        fill: true, tension: 0.4, pointRadius: 0, borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { display: false } },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    layout: { padding: { left: 0, right: 0, top: 0, bottom: 0 } },
                    elements: { line: { borderWidth: 1 } }
                }
            });
        }

        function updateMiniCharts() {
            // Only update charts for currently visible companies
            const visibleCompanySymbols = Array.from(document.querySelectorAll('.company-card'))
                                            .map(card => card.dataset.symbol);

            companies.forEach(company => {
                if (visibleCompanySymbols.includes(company.symbol)) {
                    if (miniCharts[company.symbol]) {
                        const data = (company.history && company.history.length > 0 ? company.history : [company.price])
                            .map(price => getConvertedValue(price, company.currency, selectedCurrency)); // Convert
                        miniCharts[company.symbol].data.datasets[0].data = data;
                        miniCharts[company.symbol].update('none');
                    } else {
                        renderMiniChart(company); // Re-render if it became visible
                    }
                } else if (miniCharts[company.symbol]) {
                    // Destroy chart if company is no longer visible
                    miniCharts[company.symbol].destroy();
                    delete miniCharts[company.symbol];
                }
            });
        }


        function renderStockChart(company) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (stockChart) stockChart.destroy();

            // Convert history data from company's native currency to selected display currency
            const historyDataConverted = (company.history && company.history.length > 0 ? company.history : [company.price])
                .map(price => getConvertedValue(price, company.currency, selectedCurrency));

            const labels = historyDataConverted.map((_, index) => {
                const timeAgo = (historyDataConverted.length - 1 - index) * PRICE_UPDATE_INTERVAL / 1000;
                return timeAgo === 0 ? 'Now' : `${timeAgo}s ago`;
            });

            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${company.symbol} Price`, data: historyDataConverted,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                        backgroundColor: varToRgba('--primary-color', 0.2),
                        fill: true, tension: 0.3, pointRadius: 4,
                        pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                        pointBorderColor: '#fff', pointHoverRadius: 6, borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true, title: { display: true, text: 'Time', font: { size: 14, family: 'Poppins', color: varToRgba('--text-color', 0.8) } },
                            ticks: { maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 7, font: { size: 12, family: 'Poppins', color: varToRgba('--text-color', 0.7) } },
                            grid: { display: false }
                        },
                        y: {
                            display: true, title: { display: true, text: `Price (${currencySymbols[selectedCurrency] || '$'})`, font: { size: 14, family: 'Poppins', color: varToRgba('--text-color', 0.8) } },
                            beginAtZero: false,
                            ticks: { callback: value => `${currencySymbols[selectedCurrency] || '$'}${value.toFixed(2)}`, font: { size: 12, family: 'Poppins', color: varToRgba('--text-color', 0.7) } },
                            grid: { color: '#444' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: { label: context => `${context.dataset.label}: ${currencySymbols[selectedCurrency] || '$'}${context.parsed.y.toFixed(2)}` },
                            bodyFont: { family: 'Poppins' }, titleFont: { family: 'Poppins' },
                            backgroundColor: 'rgba(0,0,0,0.7)', titleColor: varToRgba('--primary-color', 1), bodyColor: varToRgba('--text-color', 1)
                        }
                    }
                }
            });
        }

        function updateStockChart(company) {
            if (stockChart && currentCompanySymbol === company.symbol) {
                // Convert history data from company's native currency to selected display currency
                const historyDataConverted = (company.history && company.history.length > 0 ? company.history : [company.price])
                    .map(price => getConvertedValue(price, company.currency, selectedCurrency));

                const labels = historyDataConverted.map((_, index) => {
                    const timeAgo = (historyDataConverted.length - 1 - index) * PRICE_UPDATE_INTERVAL / 1000;
                    return timeAgo === 0 ? 'Now' : `${timeAgo}s ago`;
                });
                stockChart.data.labels = labels;
                stockChart.data.datasets[0].data = historyDataConverted;
                stockChart.options.scales.y.title.text = `Price (${currencySymbols[selectedCurrency] || '$'})`;
                stockChart.options.scales.y.ticks.callback = value => `${currencySymbols[selectedCurrency] || '$'}${value.toFixed(2)}`;
                stockChart.options.plugins.tooltip.callbacks.label = context => `${context.dataset.label}: ${currencySymbols[selectedCurrency] || '$'}${context.parsed.y.toFixed(2)}`;
                stockChart.update('none');
            }
        }

        function buyStocks() {
            const company = companies.find(c => c.symbol === currentCompanySymbol);
            const quantity = parseInt(buyQuantityInput.value);

            if (isNaN(quantity) || quantity <= 0) { displayPopupMessage("Please enter a valid quantity.", true); return; }
            if (quantity > company.stocksRemaining) { displayPopupMessage(`Not enough stocks. Only ${company.stocksRemaining} remaining.`, true); return; }
            
            // Cost is calculated in the stock's native currency, then converted to USD for balance check
            const costNativeCurrency = quantity * company.price;
            const costUSD = getConvertedValue(costNativeCurrency, company.currency, "USD");

            if (userBalance < costUSD) {
                const requiredFunds = getConvertedValue(costUSD - userBalance, "USD", selectedCurrency).toFixed(2);
                displayPopupMessage(`Not enough funds. You need ${currencySymbols[selectedCurrency]}${requiredFunds} more.`, true);
                return;
            }

            userBalance -= costUSD; // Balance is always stored in USD
            company.stocksRemaining -= quantity;

            if (portfolio[company.symbol]) {
                const currentTotalCostUSD = portfolio[company.symbol].quantity * portfolio[company.symbol].purchasePrice;
                portfolio[company.symbol].quantity += quantity;
                // Calculate new average purchase price in USD
                portfolio[company.symbol].purchasePrice = (currentTotalCostUSD + costUSD) / portfolio[company.symbol].quantity;
            } else {
                // Store initial purchase price in USD for accurate P/L calculation later
                portfolio[company.symbol] = { quantity: quantity, purchasePrice: costUSD / quantity };
            }

            // Store transaction price in native currency for history, but P/L will be based on USD values
            transactionHistory.push({ type: 'buy', symbol: company.symbol, name: company.name, quantity: quantity, price: company.price, timestamp: new Date().toLocaleString(), profitLoss: null, currency: company.currency });

            saveUserData();
            saveCompanyData();
            updateBalanceDisplay();
            updateAccountPLDisplay();
            renderCompanies();
            updatePortfolioDisplay();
            updateHistoryDisplay();
            displayPopupMessage(`Purchased ${quantity} shares of ${company.name} for ${formatCurrency(costNativeCurrency, company.currency)}.`); // Show original cost in stock's native currency
            openStockPopup(currentCompanySymbol); // Refresh popup
        }

        function sellStocks() {
            const company = companies.find(c => c.symbol === currentCompanySymbol);
            const ownedStock = portfolio[currentCompanySymbol];
            const quantityToSell = parseInt(sellQuantityInput.value);

            if (!ownedStock || ownedStock.quantity === 0) { displayPopupMessage("You don't own these shares.", true); return; }
            if (isNaN(quantityToSell) || quantityToSell <= 0) { displayPopupMessage("Invalid quantity.", true); return; }
            if (quantityToSell > ownedStock.quantity) { displayPopupMessage(`Can only sell up to ${ownedStock.quantity} shares.`, true); return; }

            // Revenue is calculated in stock's native currency, then converted to USD for balance update
            const revenueNativeCurrency = quantityToSell * company.price;
            const revenueUSD = getConvertedValue(revenueNativeCurrency, company.currency, "USD");

            // Profit/Loss is calculated in USD
            const profitLossPerShareUSD = getConvertedValue(company.price, company.currency, "USD") - ownedStock.purchasePrice;
            const totalProfitLossUSD = quantityToSell * profitLossPerShareUSD;

            userBalance += revenueUSD; // Balance always updated in USD
            company.stocksRemaining += quantityToSell;
            ownedStock.quantity -= quantityToSell;

            if (ownedStock.quantity === 0) delete portfolio[currentCompanySymbol];

            // Store transaction price in native currency for history, but profitLoss in USD
            transactionHistory.push({ type: 'sell', symbol: company.symbol, name: company.name, quantity: quantityToSell, price: company.price, timestamp: new Date().toLocaleString(), profitLoss: totalProfitLossUSD, currency: company.currency });

            saveUserData();
            saveCompanyData();
            updateBalanceDisplay();
            updateAccountPLDisplay();
            renderCompanies();
            updatePortfolioDisplay();
            updateHistoryDisplay();
            
            const displayedProfitLoss = getConvertedValue(totalProfitLossUSD, "USD", selectedCurrency);
            displayPopupMessage(`Sold ${quantityToSell} shares of ${company.name}. You ${displayedProfitLoss >= 0 ? 'gained' : 'lost'} ${formatCurrency(Math.abs(displayedProfitLoss), selectedCurrency)}.`);

            if (portfolio[currentCompanySymbol] && portfolio[currentCompanySymbol].quantity > 0) openStockPopup(currentCompanySymbol);
            else closeAllPopups();
        }

        function updatePortfolioDisplay() {
            portfolioListDiv.innerHTML = '';
            let hasStocks = false;
            let totalPortfolioProfitLossUSD = 0;

            for (const symbol in portfolio) {
                const item = portfolio[symbol];
                if (item.quantity > 0) {
                    hasStocks = true;
                    const company = companies.find(c => c.symbol === symbol);
                    if (!company) continue;

                    // Convert current market price to USD for P/L calculation
                    const currentMarketPriceUSD = getConvertedValue(company.price, company.currency, "USD");
                    const currentValueUSD = item.quantity * currentMarketPriceUSD;
                    const purchaseValueUSD = item.quantity * item.purchasePrice; // purchasePrice is already in USD
                    const profitLossUSD = currentValueUSD - purchaseValueUSD;
                    totalPortfolioProfitLossUSD += profitLossUSD;

                    // Convert for display
                    const displayedCurrentMarketPrice = getConvertedValue(company.price, company.currency, selectedCurrency); // Show native price converted to selected display currency
                    const displayedPurchasePrice = getConvertedValue(item.purchasePrice, "USD", selectedCurrency); // Convert stored USD purchase price to selected display currency
                    const displayedProfitLoss = getConvertedValue(profitLossUSD, "USD", selectedCurrency);

                    const portfolioItemDiv = document.createElement('div');
                    portfolioItemDiv.classList.add('portfolio-item');
                    portfolioItemDiv.innerHTML = `
                        <div><strong>${company.name} (${symbol})</strong></div>
                        <div>Qty: ${item.quantity}</div>
                        <div>Avg. Buy Price: ${formatCurrency(displayedPurchasePrice, selectedCurrency)}</div>
                        <div>Current Price: ${formatCurrency(displayedCurrentMarketPrice, selectedCurrency)}</div>
                        <div class="profit-loss ${displayedProfitLoss >= 0 ? 'profit' : 'loss'}">
                            P/L: ${displayedProfitLoss >= 0 ? '+' : '-'}${formatCurrency(Math.abs(displayedProfitLoss), selectedCurrency)}
                        </div>`;
                    portfolioListDiv.appendChild(portfolioItemDiv);
                }
            }

            if (hasStocks) {
                noPortfolioMessage.style.display = 'none';
                totalProfitLossDisplay.style.display = 'block';
                const displayedTotalPL = getConvertedValue(totalPortfolioProfitLossUSD, "USD", selectedCurrency);
                totalPLValueSpan.textContent = `${displayedTotalPL >= 0 ? '+' : '-'}${Math.abs(displayedTotalPL).toFixed(2)}`;
                totalProfitLossDisplay.className = 'total-profit-loss-display'; // Reset classes
                if (displayedTotalPL > 0) totalProfitLossDisplay.classList.add('profit-total');
                else if (displayedTotalPL < 0) totalProfitLossDisplay.classList.add('loss-total');
                else totalProfitLossDisplay.classList.add('neutral-total');
            } else {
                noPortfolioMessage.style.display = 'block';
                totalProfitLossDisplay.style.display = 'none';
            }
        }

        function updateHistoryDisplay() {
            historyListDiv.innerHTML = '';
            if (transactionHistory.length === 0) {
                noHistoryMessage.style.display = 'block'; return;
            }
            noHistoryMessage.style.display = 'none';
            transactionHistory.slice().reverse().forEach(transaction => {
                const historyItemDiv = document.createElement('div');
                historyItemDiv.classList.add('history-item');
                const typeClass = transaction.type === 'buy' ? 'buy-transaction' : 'sell-transaction';

                // Transaction price is stored in native currency, convert for display
                const displayedPrice = getConvertedValue(transaction.price, transaction.currency, selectedCurrency);
                
                let profitLossText = '';
                if (transaction.profitLoss !== null) {
                    const displayedProfitLoss = getConvertedValue(transaction.profitLoss, "USD", selectedCurrency); // ProfitLoss is stored in USD
                    profitLossText = `<span class="profit-loss ${displayedProfitLoss >= 0 ? 'profit' : 'loss'}">P/L: ${displayedProfitLoss >=0 ? '+':'-'}${formatCurrency(Math.abs(displayedProfitLoss), selectedCurrency)}</span>`;
                }

                historyItemDiv.innerHTML = `
                    <div><strong class="${typeClass}">${transaction.type.toUpperCase()}</strong>: ${transaction.name} (${transaction.symbol})</div>
                    <div>Qty: ${transaction.quantity} @ ${formatCurrency(displayedPrice, selectedCurrency)}</div>
                    <div>${transaction.timestamp}</div>
                    ${profitLossText}`;
                historyListDiv.appendChild(historyItemDiv);
            });
        }

        // --- Tab Management ---
        function openTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected tab content
            document.getElementById(tabId).classList.add('active');
            // Activate the corresponding tab button
            document.querySelector(`.tab-button[onclick="openTab('${tabId}')"]`).classList.add('active');

            // Re-render market if it's the market tab to ensure correct company filtering
            if (tabId === 'market-tab') {
                renderCompanies();
                updateMiniCharts(); // Ensure mini charts are drawn/updated for visible companies
            }
        }

        // --- Authentication Functions ---
        function openAuthPopup(mode) {
            closeAllPopups();
            authPopup.style.display = 'block';
            popupOverlay.style.display = 'block';
            isRegisterMode = (mode === 'register');
            authTitle.textContent = isRegisterMode ? 'Register' : 'Login';
            authSubmitBtn.textContent = isRegisterMode ? 'Register' : 'Login';
            document.querySelector('.toggle-auth').textContent = isRegisterMode ? 'Already have an account? Login here' : 'New user? Register here';
            usernameInput.value = ''; passwordInput.value = '';
            authMessageArea.style.display = 'none';
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            authTitle.textContent = isRegisterMode ? 'Register' : 'Login';
            authSubmitBtn.textContent = isRegisterMode ? 'Register' : 'Login';
            document.querySelector('.toggle-auth').textContent = isRegisterMode ? 'Already have an account? Login here' : 'New user? Register here';
            usernameInput.value = ''; passwordInput.value = '';
            authMessageArea.style.display = 'none';
        }

        function handleAuthSubmit() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            if (!username || !password) { displayAuthMessage("Enter username and password.", true); return; }

            if (isRegisterMode) {
                if (usersData[username]) { displayAuthMessage("Username already exists.", true); }
                else {
                    usersData[username] = { password: password, balance: INITIAL_BALANCE, portfolio: {}, history: [], favorites: [], selectedCurrency: 'USD' };
                    localStorage.setItem('users', JSON.stringify(usersData));
                    displayAuthMessage("Registration successful! Please log in.", false);
                    toggleAuthMode();
                }
            } else {
                if (usersData[username] && usersData[username].password === password) {
                    currentUser = username;
                    displayAuthMessage("Login successful!", false);
                    closeAllPopups();
                    loginSuccess();
                } else {
                    displayAuthMessage("Invalid username or password.", true);
                }
            }
        }

        function loginSuccess() {
            userInfoSpan.textContent = `Welcome, ${currentUser}!`;
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            resetAccountBtn.style.display = 'inline-block';
            mainContentDiv.style.display = 'flex';
            loadUserData(); // This also sets selectedCurrency and updates display
            populateMarketSelect(); // Populate market select after login
            filterCompaniesByCountry(); // Filter companies based on default/saved market
            openTab('market-tab'); // Open market tab by default
            startPriceUpdates();
            startNotificationUpdates();
            localStorage.setItem('lastLoggedInUser', currentUser);
        }

        function logout() {
            if (priceUpdateIntervalId) clearInterval(priceUpdateIntervalId);
            if (notificationIntervalId) clearInterval(notificationIntervalId);
            for (const symbol in miniCharts) {
                if (miniCharts[symbol]) { miniCharts[symbol].destroy(); delete miniCharts[symbol]; }
            }
            saveUserData(); // Save current user's data before logging out
            
            currentUser = null; userBalance = 0.00; portfolio = {}; transactionHistory = []; favoriteCompanies = []; selectedMarket = 'All'; selectedCurrency = 'USD'; // Reset currency and market on logout
            updateBalanceDisplay(); updateAccountPLDisplay(); updatePortfolioDisplay(); updateHistoryDisplay();
            userInfoSpan.textContent = '';
            loginBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            resetAccountBtn.style.display = 'none';
            mainContentDiv.style.display = 'none';
            renderCompanies(); // Re-render with potentially loaded prices, but favorites cleared
            closeAllPopups();
            localStorage.removeItem('lastLoggedInUser');
            openAuthPopup('login');
        }

        function resetAccount() {
            if (!currentUser) return;
            const confirmReset = confirm(`Are you sure you want to reset your account, ${currentUser}? This deletes all trades and resets balance to ${formatCurrency(INITIAL_BALANCE, 'USD')}.`);
            if (confirmReset) {
                // Create a new entry for the user with initial values.
                usersData[currentUser] = {
                    password: usersData[currentUser].password,
                    balance: INITIAL_BALANCE,
                    portfolio: {},
                    history: [],
                    favorites: [],
                    selectedCurrency: 'USD'
                };
                localStorage.setItem('users', JSON.stringify(usersData));
                alert("Account reset. You will be logged out.");
                logout();
            }
        }

        function varToRgba(cssVar, opacity) {
            const color = getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
            if (color.startsWith('#') && color.length === 7) {
                const r = parseInt(color.substring(1, 3), 16);
                const g = parseInt(color.substring(3, 5), 16);
                const b = parseInt(color.substring(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color;
        }

        // --- Initialization ---
        function startPriceUpdates() {
            if (priceUpdateIntervalId) clearInterval(priceUpdateIntervalId);
            renderCompanies();
            updateMiniCharts();
            priceUpdateIntervalId = setInterval(() => {
                updateAllStockPrices();
                updateMiniCharts();
            }, PRICE_UPDATE_INTERVAL);
        }

        function startNotificationUpdates() {
            if (notificationIntervalId) clearInterval(notificationIntervalId);
            notificationIntervalId = setInterval(() => {
                const randomMessage = newsMessages[Math.floor(Math.random() * newsMessages.length)];
                showNotification(randomMessage);
            }, NOTIFICATION_INTERVAL);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCompanyData();

            const lastLoggedInUser = localStorage.getItem('lastLoggedInUser');
            if (lastLoggedInUser && usersData[lastLoggedInUser]) {
                currentUser = lastLoggedInUser;
                loginSuccess();
            } else {
                openAuthPopup('login');
            }

            // Event listener for currency selection
            currencySelect.addEventListener('change', (event) => {
                selectedCurrency = event.target.value;
                if (currentUser) saveUserData(); // Save user's currency preference
                updateCurrencyDisplay();
                if (stockPopup.style.display === 'block' && currentCompanySymbol) {
                    const company = companies.find(c => c.symbol === currentCompanySymbol);
                    if (company) openStockPopup(currentCompanySymbol); // Re-open to refresh display
                }
            });
        });

        window.addEventListener('beforeunload', () => {
            saveUserData();
            saveCompanyData();
        });
    </script>
</body>
</html>
