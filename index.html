<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Trade Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #00BFFF; /* Deep Sky Blue - vibrant accent */
            --secondary-color: #32CD32; /* Lime Green - another accent */
            --dark-bg: #1A1A2E; /* Very Dark Blue - main background */
            --light-bg: #2C2C40; /* Slightly lighter dark blue for sections */
            --card-bg: #212135; /* Darker card background */
            --text-color: #E0E0E0; /* Light grey for text */
            --success-color: #2ECC71; /* Green */
            --error-color: #E74C3C; /* Red */
            --neutral-color: #95A5A6; /* Medium grey for neutral elements */
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #11111F 100%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll due to animations */
        }

        #header {
            background-color: var(--card-bg);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        #header h1 {
            margin: 0;
            font-size: 2.2em;
            letter-spacing: 1.5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: var(--primary-color);
        }
        #header-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        #user-info {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--secondary-color);
        }
        #balance-display, #account-pl-display {
            font-size: 1.2em;
            font-weight: 700;
            background-color: rgba(0,0,0,0.3);
            padding: 8px 18px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #balance-display span, #account-pl-display span {
            margin-left: 8px;
        }
        #balance-display #user-balance {
            color: var(--success-color);
        }
        #account-pl-value {
            color: var(--neutral-color); /* Default neutral */
        }


        #logout-btn, #login-btn, #reset-account-btn, #reset-prices-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        #logout-btn:hover, #login-btn:hover, #reset-account-btn:hover, #reset-prices-btn:hover {
            background-color: #009ACD;
            transform: translateY(-2px);
        }
        #logout-btn:active, #login-btn:active, #reset-account-btn:active, #reset-prices-btn:active {
            transform: translateY(0);
        }
        #reset-account-btn {
            background-color: var(--error-color); /* Distinct color for reset */
            margin-left: 10px; /* Spacing */
        }
        #reset-account-btn:hover {
            background-color: #C0392B;
        }
        #reset-prices-btn {
            background-color: #9B59B6; /* A distinct color for price reset, e.g., Amethyst */
            margin-left: 10px;
        }
        #reset-prices-btn:hover {
            background-color: #8E44AD;
        }


        #main-content {
            display: flex;
            flex: 1;
            padding: 30px;
            gap: 30px;
            max-width: 1600px;
            margin: 30px auto;
            animation: slideInFromTop 0.8s ease-out;
        }

        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-container {
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            padding: 25px;
            flex: 1;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #market-section { flex: 3; }
        #portfolio-section { flex: 2; }
        #history-section { flex: 1.5; min-width: 300px; } /* Added history section */


        .section-container h2 {
            color: var(--primary-color);
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
            font-size: 1.8em;
            font-weight: 600;
            text-align: center;
        }

        #companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .company-card {
            background: linear-gradient(145deg, var(--light-bg), #3A3A50);
            border: 1px solid #444460;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
            position: relative;
        }
        .company-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: translateY(-100%);
            transition: transform 0.3s ease-out;
        }
        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border-color: var(--primary-color);
        }
        .company-card:hover::before {
            transform: translateY(0);
        }

        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .company-name {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
        }
        .company-symbol {
            font-size: 1em;
            color: var(--neutral-color);
            margin-bottom: 12px;
        }
        .company-country { /* New style for country */
            font-size: 0.9em;
            color: var(--neutral-color);
            margin-top: -8px; /* Adjust spacing */
            margin-bottom: 10px;
        }
        .company-details {
            font-size: 1.1em;
            color: var(--text-color);
        }
        .stock-price {
            font-size: 1.4em;
            font-weight: 700;
            display: inline-block;
            margin-top: 8px;
        }
        .price-change {
            font-size: 1em;
            margin-left: 10px;
            font-weight: 600;
            display: inline-block;
        }
        .price-up { color: var(--success-color); }
        .price-down { color: var(--error-color); }
        .price-neutral { color: var(--neutral-color); }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--neutral-color);
            transition: color 0.2s ease, transform 0.2s ease;
            padding: 0;
            line-height: 1; /* Align star vertically */
            flex-shrink: 0;
        }
        .favorite-btn.favorited {
            color: gold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        .favorite-btn:hover {
            transform: scale(1.1);
        }


        /* Portfolio & History List Items */
        .portfolio-item, .history-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #444;
            font-size: 0.95em;
        }
        .portfolio-item:last-child, .history-item:last-child {
            border-bottom: none;
        }
        .portfolio-item div, .history-item div {
            margin-right: 15px;
            margin-bottom: 5px;
        }
        .profit-loss {
            font-weight: 700;
            margin-left: auto;
        }
        .profit { color: var(--success-color); }
        .loss { color: var(--error-color); }
        .buy-transaction { color: var(--success-color); }
        .sell-transaction { color: var(--error-color); }

        #no-portfolio-message, #no-history-message {
            color: var(--neutral-color);
            font-style: italic;
            margin-top: 15px;
            text-align: center;
        }
        
        #total-profit-loss-display { /* New CSS for total P/L */
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.4em;
            font-weight: 700;
            text-align: center;
            background-color: #3A3A50;
            border: 1px solid #444460;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }
        #total-profit-loss-display.profit-total {
            color: var(--success-color);
            border-color: var(--success-color);
        }
        #total-profit-loss-display.loss-total {
            color: var(--error-color);
            border-color: var(--error-color);
        }
        #total-profit-loss-display.neutral-total {
            color: var(--neutral-color);
            border-color: var(--neutral-color);
        }


        /* Popup Styles */
        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            border-radius: 18px;
            padding: 35px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.6);
            z-index: 1000;
            max-width: 650px;
            width: 90%;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid var(--primary-color);
            box-sizing: border-box;
            color: var(--text-color);
        }
        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }
        .popup-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 2.2em;
            font-weight: 700;
        }
        .popup-close {
            background: none;
            border: none;
            font-size: 2.5em;
            cursor: pointer;
            color: var(--neutral-color);
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .popup-close:hover {
            color: var(--error-color);
            transform: rotate(90deg);
        }
        .popup-content p {
            margin-bottom: 12px;
            font-size: 1.15em;
            color: var(--text-color);
        }
        .popup-content .current-price {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--primary-color);
        }
        .popup-content .remaining-stocks {
            font-size: 1.15em;
            color: var(--neutral-color);
        }

        #stock-chart-container {
            position: relative;
            height: 280px; /* Fixed height for the chart */
            width: 100%;
            margin-top: 25px;
            margin-bottom: 30px;
            background-color: #3A3A50;
            border: 1px solid #444460;
            border-radius: 10px;
            padding: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.15);
        }

        .action-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 25px;
            border-top: 1px solid #444;
            padding-top: 25px;
        }
        .buy-sell-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .action-section input[type="number"] {
            padding: 12px;
            border: 1px solid #666;
            background-color: #3A3A50;
            color: var(--text-color);
            border-radius: 8px;
            width: 120px;
            font-size: 1.1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .action-section input[type="number"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.2);
            outline: none;
        }
        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.15em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn:hover {
            background-color: #009ACD;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .btn.sell {
            background-color: var(--error-color);
        }
        .btn.sell:hover {
            background-color: #C0392B;
        }
        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .message-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.05em;
            text-align: center;
            animation: fadeIn 0.4s ease-out;
            display: none; /* Hidden by default */
        }
        .message-success {
            background-color: #285A36;
            color: #D4EDDA;
            border: 1px solid #367A47;
        }
        .message-error {
            background-color: #7A2E35;
            color: #F8D7DA;
            border: 1px solid #A13A43;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 999;
            backdrop-filter: blur(5px);
        }

        /* Login/Register Popup */
        #auth-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--card-bg) 0%, #2A2A3F 100%);
            border-radius: 18px;
            padding: 35px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.7);
            z-index: 1001; /* Higher than stock popup */
            max-width: 450px;
            width: 90%;
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid var(--secondary-color);
            text-align: center;
        }
        #auth-popup h2 {
            color: var(--primary-color);
            font-size: 2em;
            margin-bottom: 25px;
        }
        #auth-popup label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        #auth-popup input[type="text"],
        #auth-popup input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #666;
            background-color: #3A3A50;
            color: var(--text-color);
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #auth-popup input[type="text"]:focus,
        #auth-popup input[type="password"]:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(50, 205, 50, 0.2);
            outline: none;
        }
        #auth-popup .btn-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        #auth-popup .btn {
            width: 150px;
        }
        #auth-popup .toggle-auth {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1em;
            margin-top: 25px;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.3s ease;
        }
        #auth-popup .toggle-auth:hover {
            color: #009ACD;
        }

        #auth-message-area {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            font-weight: 500;
        }

        /* Notification styles */
        #notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
            pointer-events: none; /* Allows clicks to pass through */
        }

        .notification-item {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateX(100%);
            animation: slideInNotification 0.5s forwards, fadeOutNotification 0.5s 4.5s forwards;
            pointer-events: all; /* Make notification clickable */
            border-left: 5px solid var(--secondary-color);
        }

        @keyframes slideInNotification {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOutNotification {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }


        /* Responsive adjustments */
        @media (max-width: 1200px) {
            #main-content {
                flex-direction: column;
                padding: 20px;
                gap: 20px;
            }
            #market-section, #portfolio-section, #history-section {
                flex: none; /* Remove flex grow/shrink */
                width: 100%; /* Make them full width */
            }
            #companies-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            #header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            #header h1 {
                font-size: 1.8em;
            }
            #balance-display, #account-pl-display {
                font-size: 1.2em;
            }
            .company-card {
                padding: 15px;
            }
            .company-name {
                font-size: 1.2em;
            }
            .stock-price {
                font-size: 1.2em;
            }
            .popup {
                padding: 25px;
            }
            .popup-header h3 {
                font-size: 1.8em;
            }
            #auth-popup {
                padding: 25px;
            }
            #notification-container {
                bottom: 10px;
                right: 10px;
                max-width: calc(100% - 20px);
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Infinity Trade Simulator</h1>
        <div id="header-right">
            <div id="user-info"></div>
            <div id="balance-display">
                Balance: LKR<span id="user-balance">0.00</span>
            </div>
            <div id="account-pl-display">
                Account P/L: <span id="account-pl-value"></span>
            </div>
            <button id="login-btn" onclick="openAuthPopup('login')">Login / Register</button>
            <button id="logout-btn" style="display:none;" onclick="logout()">Logout</button>
            <button id="reset-account-btn" style="display:none;" onclick="resetAccount()">Reset Account</button>
            <button id="reset-prices-btn" style="display:none;" onclick="resetPrices()">Reset Prices</button>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div id="market-section" class="section-container">
            <h2>Market Overview</h2>
            <div id="companies-grid">
                </div>
        </div>

        <div id="portfolio-section" class="section-container">
            <h2>Your Portfolio</h2>
            <div id="portfolio-list">
                <p id="no-portfolio-message">You don't own any shares yet.</p>
                </div>
            <div id="total-profit-loss-display" style="display:none;">
                Total P/L: <span id="total-pl-value"></span>
            </div>
        </div>

        <div id="history-section" class="section-container">
            <h2>Transaction History</h2>
            <div id="history-list">
                <p id="no-history-message">No transactions recorded yet.</p>
                </div>
        </div>
    </div>
    <div id="popup-overlay" class="overlay" onclick="closeAllPopups()"></div>

    <div id="stock-popup" class="popup">
        <div class="popup-header">
            <h3 id="popup-company-name"></h3>
            <button class="popup-close" onclick="closeAllPopups()">&times;</button>
        </div>
        <div class="popup-content">
            <p>Current Price: LKR<span id="popup-stock-price" class="current-price"></span></p>
            <p class="remaining-stocks">Stocks Available: <span id="popup-remaining-stocks"></span></p>

            <div id="stock-chart-container">
                <canvas id="stockChart"></canvas>
            </div>

            <div class="action-section">
                <div class="buy-sell-group">
                    <input type="number" id="buy-quantity" min="1" value="1" placeholder="Qty">
                    <button class="btn" id="buy-button" onclick="buyStocks()">Buy</button>
                </div>
                <div id="sell-group" class="buy-sell-group" style="display: none;">
                    <p>You own: <span id="popup-owned-stocks"></span> shares</p>
                    <input type="number" id="sell-quantity" min="1" value="1" placeholder="Qty">
                    <button class="btn sell" id="sell-button" onclick="sellStocks()">Sell</button>
                </div>
            </div>
            <div id="popup-message-area" class="message-area"></div>
        </div>
    </div>

    <div id="auth-popup" class="popup">
        <div class="popup-header">
            <h2 id="auth-title">Login</h2>
            <button class="popup-close" onclick="closeAllPopups()">&times;</button>
        </div>
        <form id="auth-form" onsubmit="event.preventDefault(); handleAuthSubmit();">
            <label for="username">Username:</label>
            <input type="text" id="username" required>
            <label for="password">Password:</label>
            <input type="password" id="password" required>
            <div class="btn-group">
                <button type="submit" class="btn" id="auth-submit-btn">Login</button>
            </div>
            <p id="auth-message-area" class="message-area"></p>
            <button type="button" class="toggle-auth" onclick="toggleAuthMode()">New user? Register here</button>
        </form>
    </div>

    <div id="notification-container"></div>
    <script>
        // --- Global Variables and Constants ---
        let userBalance = 0.00;
        const INITIAL_BALANCE = 10000.00; // Define initial balance
        let currentUser = null; // Stores username of logged-in user
        const PRICE_UPDATE_INTERVAL = 10000; // 10 seconds
        const NOTIFICATION_INTERVAL = 20000; // 20 seconds for notifications
        const MAX_HISTORY_POINTS = 20; // Number of price points to keep for the graph
        const PRICE_MULTIPLIER = 300; // New constant for price scaling

        // Original, immutable base data for companies. Prices are now base values.
        const INITIAL_COMPANIES_DATA = [
            { name: "John Keells Holdings PLC", symbol: "JKH.N0000", price: 21.00 / PRICE_MULTIPLIER, stocksRemaining: 7962613, volatility: 0.019, history: [], country: "Sri Lanka" },
            { name: "LOLC Holdings PLC", symbol: "LOLC.N0000", price: 621.00 / PRICE_MULTIPLIER, stocksRemaining: 619188, volatility: 0.025, history: [], country: "Sri Lanka" },
            { name: "Commercial Bank of Ceylon PLC", symbol: "COMB.N0000", price: 153.00 / PRICE_MULTIPLIER, stocksRemaining: 746494, volatility: 0.015, history: [], country: "Sri Lanka" },
            { name: "Hatton National Bank PLC", symbol: "HNB.N0000", price: 321.00 / PRICE_MULTIPLIER, stocksRemaining: 203533, volatility: 0.016, history: [], country: "Sri Lanka" },
            { name: "Dialog Axiata PLC", symbol: "DIAL.N0000", price: 18.00 / PRICE_MULTIPLIER, stocksRemaining: 3163154, volatility: 0.020, history: [], country: "Sri Lanka" },
            { name: "Sri Lanka Telecom PLC", symbol: "SLTL.N0000", price: 63.00 / PRICE_MULTIPLIER, stocksRemaining: 57238, volatility: 0.018, history: [], country: "Sri Lanka" },
            { name: "Sampath Bank PLC", symbol: "SAMP.N0000", price: 39.00 / PRICE_MULTIPLIER, stocksRemaining: 1054296, volatility: 0.017, history: [], country: "Sri Lanka" },
            { name: "Browns Investments PLC", symbol: "BIL.N0000", price: 6.00   / PRICE_MULTIPLIER, stocksRemaining: 18631081, volatility: 0.022, history: [], country: "Sri Lanka" },
            { name: "Hayleys PLC", symbol: "HAYL.N0000", price: 156.00 / PRICE_MULTIPLIER, stocksRemaining: 811710, volatility: 0.020, history: [], country: "Sri Lanka" },
            { name: "Access Engineering PLC", symbol: "AEL.N0000", price: 42.14 / PRICE_MULTIPLIER, stocksRemaining: 3790884, volatility: 0.019, history: [], country: "Sri Lanka" },
            { name: "Vallibel One PLC", symbol: "VONE.N0000", price: 75.00 / PRICE_MULTIPLIER, stocksRemaining: 1226544, volatility: 0.021, history: [], country: "Sri Lanka" },
            { name: "Hemas Holdings PLC", symbol: "HHL.N0000", price: 27.00 / PRICE_MULTIPLIER, stocksRemaining: 9588068, volatility: 0.014, history: [], country: "Sri Lanka" },
            { name: "Nawaloka Hospitals PLC", symbol: "NHL.N0000", price: 6.00 / PRICE_MULTIPLIER, stocksRemaining: 119923, volatility: 0.014, history: [], country: "Sri Lanka" },
            { name: "Swisstek PLC", symbol: "PARQ.N0000", price: 72.00 / PRICE_MULTIPLIER, stocksRemaining: 2612365, volatility: 0.014, history: [], country: "Sri Lanka" }
        ];

        let companies = []; // This will hold the mutable company data, initialized from INITIAL_COMPANIES_DATA

        let portfolio = {}; // { symbol: { quantity: X, purchasePrice: Y } }
        let transactionHistory = []; // [{ type: 'buy/sell', symbol: 'AAPL', quantity: 5, price: 170.50, timestamp: '...', profitLoss: null }]
        let favoriteCompanies = []; // Array of symbols for favorite companies

        // Persistent data structure for users (in localStorage)
        let usersData = JSON.parse(localStorage.getItem('users') || '{}');

        // DOM Elements
        const userBalanceSpan = document.getElementById('user-balance');
        const accountPLValueSpan = document.getElementById('account-pl-value'); // New element
        const companiesGridDiv = document.getElementById('companies-grid');
        const stockPopup = document.getElementById('stock-popup');
        const popupOverlay = document.getElementById('popup-overlay');
        const popupCompanyName = document.getElementById('popup-company-name');
        const popupRemainingStocks = document.getElementById('popup-remaining-stocks');
        const popupStockPrice = document.getElementById('popup-stock-price');
        const buyQuantityInput = document.getElementById('buy-quantity');
        const buyButton = document.getElementById('buy-button');
        const sellGroup = document.getElementById('sell-group');
        const popupOwnedStocks = document.getElementById('popup-owned-stocks');
        const sellQuantityInput = document.getElementById('sell-quantity');
        const portfolioListDiv = document.getElementById('portfolio-list');
        const noPortfolioMessage = document.getElementById('no-portfolio-message');
        const totalProfitLossDisplay = document.getElementById('total-profit-loss-display'); // New Element
        const totalPLValueSpan = document.getElementById('total-pl-value'); // New Element
        const historyListDiv = document.getElementById('history-list');
        const noHistoryMessage = document.getElementById('no-history-message');
        const popupMessageArea = document.getElementById('popup-message-area');
        const userInfoSpan = document.getElementById('user-info');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const resetAccountBtn = document.getElementById('reset-account-btn'); // New element
        const resetPricesBtn = document.getElementById('reset-prices-btn'); // New element
        const mainContentDiv = document.getElementById('main-content');
        const authPopup = document.getElementById('auth-popup');
        const authTitle = document.getElementById('auth-title');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authMessageArea = document.getElementById('auth-message-area');
        const notificationContainer = document.getElementById('notification-container'); // New element

        let isRegisterMode = false;

        let currentCompanySymbol = null;
        let stockChart;
        let priceUpdateIntervalId;
        let notificationIntervalId; // New interval ID for notifications

        const newsMessages = [
            "Global market volatility expected next week.",
            "Tech sector in USA shows strong growth, analysts predict further gains.",
            "Energy prices fluctuate amid global supply concerns.",
            "Healthcare innovations in Europe driving new investment opportunities.",
            "Consumer spending in Asia remains robust, boosting retail stocks.",
            "Interest rate hike anticipated in USA, bond markets react.",
            "Manufacturing output in China beats expectations, positive outlook for industrials.",
            "Global trade tensions ease, bringing relief to commodity markets.",
            "New AI advancements creating buzz in the semiconductor industry worldwide.",
            "Real estate market in India stabilizes after recent corrections."
        ];


        // --- Local Storage Functions ---
        function saveUserData() {
            if (currentUser) {
                usersData[currentUser] = {
                    password: usersData[currentUser].password, // Keep password for re-login
                    balance: userBalance,
                    portfolio: portfolio,
                    history: transactionHistory,
                    favorites: favoriteCompanies // Save favorites
                };
                localStorage.setItem('users', JSON.stringify(usersData));
            }
            // Save current state of companies data (prices and history)
            localStorage.setItem('companiesData', JSON.stringify(companies));
        }

        function loadUserData() {
            // Load companies data first
            const savedCompanies = JSON.parse(localStorage.getItem('companiesData'));
            if (savedCompanies && savedCompanies.length > 0) {
                companies = savedCompanies;
                // Ensure history array exists and is trimmed
                companies.forEach(company => {
                    if (!company.history) {
                        company.history = [company.price];
                    } else if (company.history.length > MAX_HISTORY_POINTS) {
                        company.history = company.history.slice(-MAX_HISTORY_POINTS);
                    }
                });
            } else {
                // If no saved companies data, use initial data and initialize history
                companies = JSON.parse(JSON.stringify(INITIAL_COMPANIES_DATA)); // Deep copy
                companies.forEach(company => {
                    company.history = [company.price];
                });
            }


            if (currentUser && usersData[currentUser]) {
                const userData = usersData[currentUser];
                userBalance = userData.balance !== undefined ? userData.balance : INITIAL_BALANCE;
                portfolio = userData.portfolio || {};
                transactionHistory = userData.history || [];
                favoriteCompanies = userData.favorites || []; // Load favorites
            } else {
                userBalance = INITIAL_BALANCE; // Set initial balance for new users
                portfolio = {};
                transactionHistory = [];
                favoriteCompanies = []; // Initialize empty favorites
            }
            updateBalanceDisplay();
            updateAccountPLDisplay(); // Call new function
            updatePortfolioDisplay();
            updateHistoryDisplay();
            renderCompanies(); // Re-render companies grid after loading data
        }

        // --- UI Update Functions ---
        function updateBalanceDisplay() {
            userBalanceSpan.textContent = userBalance.toFixed(2);
        }

        function updateAccountPLDisplay() {
            // Calculate current account value: balance + sum of (current stock values - purchase price)
            let totalPortfolioValue = 0;
            for (const symbol in portfolio) {
                const item = portfolio[symbol];
                const company = companies.find(c => c.symbol === symbol);
                if (company) {
                    totalPortfolioValue += item.quantity * (company.price * PRICE_MULTIPLIER);
                }
            }
            const totalInvested = Object.values(portfolio).reduce((sum, item) => sum + (item.quantity * (item.purchasePrice * PRICE_MULTIPLIER)), 0);

            const accountProfitLoss = (userBalance + totalPortfolioValue) - (INITIAL_BALANCE + totalInvested);

            accountPLValueSpan.textContent = `${accountProfitLoss >= 0 ? '+' : ''}${accountProfitLoss.toFixed(2)}`;
            accountPLValueSpan.classList.remove('profit', 'loss', 'neutral');
            if (accountProfitLoss > 0) {
                accountPLValueSpan.classList.add('profit');
            } else if (accountProfitLoss < 0) {
                accountPLValueSpan.classList.add('loss');
            } else {
                accountPLValueSpan.classList.add('neutral');
            }
        }


        function displayPopupMessage(message, isError = false) {
            popupMessageArea.textContent = message;
            popupMessageArea.classList.remove('message-success', 'message-error');
            if (isError) {
                popupMessageArea.classList.add('message-error');
            } else {
                popupMessageArea.classList.add('message-success');
            }
            popupMessageArea.style.display = 'block';
            setTimeout(() => {
                popupMessageArea.style.display = 'none';
            }, 3000);
        }

        function displayAuthMessage(message, isError = false) {
            authMessageArea.textContent = message;
            authMessageArea.classList.remove('message-success', 'message-error');
            if (isError) {
                authMessageArea.classList.add('message-error');
            } else {
                authMessageArea.classList.add('message-success');
            }
            authMessageArea.style.display = 'block';
            setTimeout(() => {
                authMessageArea.style.display = 'none';
            }, 3000);
        }

        function showNotification(message) {
            const notificationItem = document.createElement('div');
            notificationItem.classList.add('notification-item');
            notificationItem.textContent = message;
            notificationContainer.appendChild(notificationItem);

            setTimeout(() => {
                notificationItem.remove();
            }, 5000); // Notification disappears after 5 seconds
        }

        // --- Core Game Logic Functions ---

        function generateNewPrice(currentPrice, volatility) {
            const factor = (Math.random() * 2 - 1) * volatility * 0.5;
            let newPrice = currentPrice * (1 + factor);

            // Ensure price does not go below a reasonable minimum (base price)
            if (newPrice < 0.01 / PRICE_MULTIPLIER) {
                newPrice = (0.01 + Math.random() * 0.01) / PRICE_MULTIPLIER;
            }
            return parseFloat(newPrice.toFixed(5)); // Keep more precision for base price
        }

        function updateAllStockPrices() {
            companies.forEach(company => {
                const oldPriceBase = company.price;
                company.price = generateNewPrice(company.price, company.volatility);

                company.history.push(company.price); // Store base price in history
                if (company.history.length > MAX_HISTORY_POINTS) {
                    company.history.shift();
                }

                const card = document.querySelector(`.company-card[data-symbol="${company.symbol}"]`);
                if (card) {
                    const priceSpan = card.querySelector('.stock-price-value');
                    const changeSpan = card.querySelector('.price-change');
                    const diff = (company.price - oldPriceBase) * PRICE_MULTIPLIER; // Calculate diff based on multiplied price

                    priceSpan.textContent = (company.price * PRICE_MULTIPLIER).toFixed(2);
                    changeSpan.textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(2)}`;
                    changeSpan.classList.remove('price-up', 'price-down', 'price-neutral');
                    if (diff > 0) {
                        changeSpan.classList.add('price-up');
                    } else if (diff < 0) {
                        changeSpan.classList.add('price-down');
                    } else {
                        changeSpan.classList.add('price-neutral');
                    }
                }

                if (currentCompanySymbol === company.symbol && stockPopup.style.display === 'block') {
                    popupStockPrice.textContent = (company.price * PRICE_MULTIPLIER).toFixed(2);
                    updateStockChart(company);
                }
            });
            updatePortfolioDisplay(); // Update portfolio values as current prices have changed
            updateAccountPLDisplay(); // Update account P/L based on new prices
        }  

        function renderCompanies() {
            companiesGridDiv.innerHTML = '';

            // Sort companies: favorites first, then alphabetically
            const sortedCompanies = [...companies].sort((a, b) => {
                const aIsFavorite = favoriteCompanies.includes(a.symbol);
                const bIsFavorite = favoriteCompanies.includes(b.symbol);

                if (aIsFavorite && !bIsFavorite) return -1;
                if (!aIsFavorite && bIsFavorite) return 1;
                return a.name.localeCompare(b.name);
            });

            sortedCompanies.forEach(company => {
                const companyCard = document.createElement('div');
                companyCard.classList.add('company-card');
                companyCard.dataset.symbol = company.symbol;

                // Ensure history has at least one point for initial rendering
                if (!company.history || company.history.length === 0) {
                    company.history = [company.price]; // Store base price
                }

                const prevPriceBase = company.history[company.history.length - 2] || company.price; // Get base price
                const diff = (company.price - prevPriceBase) * PRICE_MULTIPLIER; // Calculate diff based on multiplied price
                let priceChangeClass = 'price-neutral';
                if (diff > 0) priceChangeClass = 'price-up';
                else if (diff < 0) priceChangeClass = 'price-down';

                const priceChangeText = `${diff >= 0 ? '+' : ''}${diff.toFixed(2)}`;
                const isFavorited = favoriteCompanies.includes(company.symbol);

                companyCard.innerHTML = `
                    <div class="company-header">
                        <div class="company-name">${company.name}</div>
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite('${company.symbol}')">â˜…</button>
                    </div>
                    <div class="company-symbol">${company.symbol}</div>
                    <div class="company-country">${company.country}</div>
                    <div class="company-details">
                        Stocks Available: ${company.stocksRemaining}<br>
                        Price: LKR<span class="stock-price stock-price-value">${(company.price * PRICE_MULTIPLIER).toFixed(2)}</span>
                        <span class="price-change ${priceChangeClass}">${priceChangeText}</span>
                    </div>
                    <div class="mini-chart-container" style="height: 60px; width: 100%; margin-top: 10px;">
                        <canvas id="miniChart-${company.symbol}"></canvas>
                    </div>
                `;
                companyCard.onclick = () => openStockPopup(company.symbol);
                companiesGridDiv.appendChild(companyCard);

                // Initialize mini-chart for each company
                renderMiniChart(company);
            });
        }

        function toggleFavorite(symbol) {
            if (!currentUser) {
                openAuthPopup('login');
                displayAuthMessage("Please log in to manage favorites.", true);
                return;
            }

            const index = favoriteCompanies.indexOf(symbol);
            if (index > -1) {
                favoriteCompanies.splice(index, 1); // Remove from favorites
            } else {
                favoriteCompanies.push(symbol); // Add to favorites
            }
            saveUserData();
            renderCompanies(); // Re-render to reflect favorite status and sorting
        }

        function openStockPopup(symbol) {
            if (!currentUser) {
                openAuthPopup('login');
                displayAuthMessage("Please log in to trade stocks.", true);
                return;
            }

            currentCompanySymbol = symbol;
            const company = companies.find(c => c.symbol === symbol);
            if (!company) return;

            popupCompanyName.textContent = company.name;
            popupRemainingStocks.textContent = company.stocksRemaining;
            popupStockPrice.textContent = (company.price * PRICE_MULTIPLIER).toFixed(2); // Display multiplied price
            buyQuantityInput.value = 1;

            if (portfolio[symbol] && portfolio[symbol].quantity > 0) {
                sellGroup.style.display = 'flex';
                popupOwnedStocks.textContent = portfolio[symbol].quantity;
                sellQuantityInput.max = portfolio[symbol].quantity;
                sellQuantityInput.value = 1;
            } else {
                sellGroup.style.display = 'none';
            }

            stockPopup.style.display = 'block';
            popupOverlay.style.display = 'block';

            renderStockChart(company);
        }

        function closeAllPopups() {
            stockPopup.style.display = 'none';
            authPopup.style.display = 'none';
            popupOverlay.style.display = 'none';
            currentCompanySymbol = null;
            if (stockChart) {
                stockChart.destroy();
                stockChart = null;
            }
            popupMessageArea.style.display = 'none';
            authMessageArea.style.display = 'none';
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // Dictionary to hold Chart.js instances for mini-charts
        const miniCharts = {};

        function renderMiniChart(company) {
            const ctx = document.getElementById(`miniChart-${company.symbol}`).getContext('2d');

            if (miniCharts[company.symbol]) {
                miniCharts[company.symbol].destroy();
            }

            // Data for chart should be multiplied prices
            const data = company.history.length > 0 ? company.history.map(p => p * PRICE_MULTIPLIER) : [(company.price * PRICE_MULTIPLIER)];

            miniCharts[company.symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(data.length).fill(''), // No labels on mini chart
                    datasets: [{
                        data: data,
                        borderColor: varToRgba('--primary-color', 0.8),
                        backgroundColor: varToRgba('--primary-color', 0.1),
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0, // No points on mini chart
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    layout: {
                        padding: {
                            left: 0,
                            right: 0,
                            top: 0,
                            bottom: 0
                        }
                    },
                    elements: {
                        line: {
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        function updateMiniCharts() {
            companies.forEach(company => {
                if (miniCharts[company.symbol]) {
                    // Data for chart should be multiplied prices
                    const data = company.history.length > 0 ? company.history.map(p => p * PRICE_MULTIPLIER) : [(company.price * PRICE_MULTIPLIER)];
                    miniCharts[company.symbol].data.datasets[0].data = data;
                    miniCharts[company.symbol].update('none'); // 'none' for no animation
                } else {
                    // If chart not yet rendered (e.g., first load), call renderMiniChart
                    renderMiniChart(company);
                }
            });
        }


        function renderStockChart(company) {
            const ctx = document.getElementById('stockChart').getContext('2d');

            if (stockChart) {
                stockChart.destroy();
            }

            const labels = company.history.map((_, index) => {
                const timeAgo = (company.history.length - 1 - index) * PRICE_UPDATE_INTERVAL / 1000;
                return timeAgo === 0 ? 'Now' : `${timeAgo}s ago`;
            });

            // Chart data should be multiplied prices
            const chartData = company.history.map(p => p * PRICE_MULTIPLIER);

            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${company.symbol} Price`,
                        data: chartData,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                        backgroundColor: varToRgba('--primary-color', 0.2),
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time',
                                font: { size: 14, family: 'Poppins', color: varToRgba('--text-color', 0.8) }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 7,
                                font: { size: 12, family: 'Poppins', color: varToRgba('--text-color', 0.7) }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price (LKR)',
                                font: { size: 14, family: 'Poppins', color: varToRgba('--text-color', 0.8) }
                            },
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'LKR' + value.toFixed(2);
                                },
                                font: { size: 12, family: 'Poppins', color: varToRgba('--text-color', 0.7) }
                            },
                            grid: {
                                color: '#444' /* Darker grid lines for dark theme */
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: LKR${context.parsed.y.toFixed(2)}`;
                                }
                            },
                            bodyFont: { family: 'Poppins' },
                            titleFont: { family: 'Poppins' },
                            backgroundColor: 'rgba(0,0,0,0.7)', /* Darker tooltip background */
                            titleColor: varToRgba('--primary-color', 1),
                            bodyColor: varToRgba('--text-color', 1)
                        }
                    }
                }
            });
        }

        function updateStockChart(company) {
            if (stockChart && currentCompanySymbol === company.symbol) {
                const labels = company.history.map((_, index) => {
                    const timeAgo = (company.history.length - 1 - index) * PRICE_UPDATE_INTERVAL / 1000;
                    return timeAgo === 0 ? 'Now' : `${timeAgo}s ago`;
                });
                stockChart.data.labels = labels;
                stockChart.data.datasets[0].data = company.history.map(p => p * PRICE_MULTIPLIER); // Chart data should be multiplied prices
                stockChart.update('none');
            }
        }

        function buyStocks() {
            const company = companies.find(c => c.symbol === currentCompanySymbol);
            const quantity = parseInt(buyQuantityInput.value);

            if (isNaN(quantity) || quantity <= 0) {
                displayPopupMessage("Please enter a valid quantity.", true);
                return;
            }

            if (quantity > company.stocksRemaining) {
                displayPopupMessage(`Not enough stocks available. Only ${company.stocksRemaining} remaining.`, true);
                return;
            }

            const cost = quantity * (company.price * PRICE_MULTIPLIER); // Calculate cost with multiplied price
            if (userBalance < cost) {
                displayPopupMessage("Not enough funds to complete this purchase.", true);
                return;
            }

            userBalance -= cost;
            company.stocksRemaining -= quantity;

            if (portfolio[company.symbol]) {
                const currentTotalCost = portfolio[company.symbol].quantity * (portfolio[company.symbol].purchasePrice * PRICE_MULTIPLIER);
                portfolio[company.symbol].quantity += quantity;
                // Store average purchase price as base price
                portfolio[company.symbol].purchasePrice = (currentTotalCost + cost) / portfolio[company.symbol].quantity / PRICE_MULTIPLIER;
            } else {
                // Store purchase price as base price
                portfolio[company.symbol] = {
                    quantity: quantity,
                    purchasePrice: company.price
                };
            }

            transactionHistory.push({
                type: 'buy',
                symbol: company.symbol,
                name: company.name,
                quantity: quantity,
                price: company.price * PRICE_MULTIPLIER, // Store transaction price as multiplied price
                timestamp: new Date().toLocaleString(),
                profitLoss: null
            });

            saveUserData();
            updateBalanceDisplay();
            updateAccountPLDisplay(); // Update account P/L after transaction
            renderCompanies();
            updatePortfolioDisplay();
            updateHistoryDisplay();
            displayPopupMessage(`Successfully purchased ${quantity} shares of ${company.name} for LKR${cost.toFixed(2)}.`);
            openStockPopup(currentCompanySymbol);
        }

        function sellStocks() {
            const company = companies.find(c => c.symbol === currentCompanySymbol);
            const ownedStock = portfolio[currentCompanySymbol];
            const quantityToSell = parseInt(sellQuantityInput.value);

            if (!ownedStock || ownedStock.quantity === 0) {
                displayPopupMessage("You don't own any shares of this company.", true);
                return;
            }

            if (isNaN(quantityToSell) || quantityToSell <= 0) {
                displayPopupMessage("Please enter a valid quantity to sell.", true);
                return;
            }

            if (quantityToSell > ownedStock.quantity) {
                displayPopupMessage(`You can only sell up to ${ownedStock.quantity} shares.`, true);
                return;
            }

            const revenue = quantityToSell * (company.price * PRICE_MULTIPLIER); // Calculate revenue with multiplied price
            const profitLossPerShare = (company.price * PRICE_MULTIPLIER) - (ownedStock.purchasePrice * PRICE_MULTIPLIER); // Calculate P/L per share with multiplied prices
            const totalProfitLoss = quantityToSell * profitLossPerShare; // Total P/L is already multiplied

            userBalance += revenue;
            company.stocksRemaining += quantityToSell;
            ownedStock.quantity -= quantityToSell;

            if (ownedStock.quantity === 0) {
                delete portfolio[currentCompanySymbol];
            }

            transactionHistory.push({
                type: 'sell',
                symbol: company.symbol,
                name: company.name,
                quantity: quantityToSell,
                price: company.price * PRICE_MULTIPLIER, // Store transaction price as multiplied price
                timestamp: new Date().toLocaleString(),
                profitLoss: totalProfitLoss // Store total P/L as multiplied value
            });

            saveUserData();
            updateBalanceDisplay();
            updateAccountPLDisplay(); // Update account P/L after transaction
            renderCompanies();
            updatePortfolioDisplay();
            updateHistoryDisplay();
            displayPopupMessage(`Sold ${quantityToSell} shares of ${company.name}. You ${totalProfitLoss >= 0 ? 'gained' : 'lost'} LKR${Math.abs(totalProfitLoss).toFixed(2)}.`);

            if (portfolio[currentCompanySymbol] && portfolio[currentCompanySymbol].quantity > 0) {
                openStockPopup(currentCompanySymbol);
            } else {
                closeAllPopups();
            }
        }

        function updatePortfolioDisplay() {
            portfolioListDiv.innerHTML = '';
            let hasStocks = false;
            let totalPortfolioProfitLoss = 0; // Initialize total profit/loss

            for (const symbol in portfolio) {
                const item = portfolio[symbol];
                if (item.quantity > 0) {
                    hasStocks = true;
                    const company = companies.find(c => c.symbol === symbol);
                    if (!company) continue;

                    const currentMarketPrice = company.price * PRICE_MULTIPLIER; // Get multiplied price
                    const currentValue = item.quantity * currentMarketPrice;
                    const purchaseValue = item.quantity * (item.purchasePrice * PRICE_MULTIPLIER); // Get multiplied purchase price
                    const profitLoss = currentValue - purchaseValue;
                    totalPortfolioProfitLoss += profitLoss; // Add to total

                    const portfolioItemDiv = document.createElement('div');
                    portfolioItemDiv.classList.add('portfolio-item');
                    portfolioItemDiv.innerHTML = `
                        <div><strong>${company.name} (${symbol})</strong></div>
                        <div>Qty: ${item.quantity}</div>
                        <div>Avg. Buy Price: LKR${(item.purchasePrice * PRICE_MULTIPLIER).toFixed(2)}</div>
                        <div>Current Price: LKR${currentMarketPrice.toFixed(2)}</div>
                        <div class="profit-loss ${profitLoss >= 0 ? 'profit' : 'loss'}">
                            P/L: LKR${Math.abs(profitLoss).toFixed(2)}
                        </div>
                    `;
                    portfolioListDiv.appendChild(portfolioItemDiv);
                }
            }

            if (hasStocks) {
                noPortfolioMessage.style.display = 'none';
                totalProfitLossDisplay.style.display = 'block';
                totalPLValueSpan.textContent = `${totalPortfolioProfitLoss >= 0 ? '+' : '-'}${Math.abs(totalPortfolioProfitLoss).toFixed(2)}`;
                totalProfitLossDisplay.classList.remove('profit-total', 'loss-total', 'neutral-total');
                if (totalPortfolioProfitLoss > 0) {
                    totalProfitLossDisplay.classList.add('profit-total');
                } else if (totalPortfolioProfitLoss < 0) {
                    totalProfitLossDisplay.classList.add('loss-total');
                } else {
                    totalProfitLossDisplay.classList.add('neutral-total');
                }
            } else {
                noPortfolioMessage.style.display = 'block';
                totalProfitLossDisplay.style.display = 'none'; // Hide if no stocks
            }
        }


        function updateHistoryDisplay() {
            historyListDiv.innerHTML = '';
            if (transactionHistory.length === 0) {
                noHistoryMessage.style.display = 'block';
                return;
            }
            noHistoryMessage.style.display = 'none';

            transactionHistory.slice().reverse().forEach(transaction => {
                const historyItemDiv = document.createElement('div');
                historyItemDiv.classList.add('history-item');
                const typeClass = transaction.type === 'buy' ? 'buy-transaction' : 'sell-transaction';
                const profitLossText = transaction.profitLoss !== null
                    ? `<span class="profit-loss ${transaction.profitLoss >= 0 ? 'profit' : 'loss'}">P/L: LKR${Math.abs(transaction.profitLoss).toFixed(2)}</span>`
                    : '';

                historyItemDiv.innerHTML = `
                    <div><strong class="${typeClass}">${transaction.type.toUpperCase()}</strong>: ${transaction.name} (${transaction.symbol})</div>
                    <div>Qty: ${transaction.quantity} @ LKR${transaction.price.toFixed(2)}</div>
                    <div>${transaction.timestamp}</div>
                    ${profitLossText}
                `;
                historyListDiv.appendChild(historyItemDiv);
            });
        }

        // --- Authentication Functions ---
        function openAuthPopup(mode) {
            closeAllPopups();
            authPopup.style.display = 'block';
            popupOverlay.style.display = 'block';
            isRegisterMode = (mode === 'register');
            authTitle.textContent = isRegisterMode ? 'Register' : 'Login';
            authSubmitBtn.textContent = isRegisterMode ? 'Register' : 'Login';
            document.querySelector('.toggle-auth').textContent = isRegisterMode ? 'Already have an account? Login here' : 'New user? Register here';
            usernameInput.value = '';
            passwordInput.value = '';
            authMessageArea.style.display = 'none';
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            authTitle.textContent = isRegisterMode ? 'Register' : 'Login';
            authSubmitBtn.textContent = isRegisterMode ? 'Register' : 'Login';
            document.querySelector('.toggle-auth').textContent = isRegisterMode ? 'Already have an account? Login here' : 'New user? Register here';
            usernameInput.value = '';
            passwordInput.value = '';
            authMessageArea.style.display = 'none';
        }

        function handleAuthSubmit() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                displayAuthMessage("Please enter both username and password.", true);
                return;
            }

            if (isRegisterMode) {
                if (usersData[username]) {
                    displayAuthMessage("Username already exists. Please choose another.", true);
                } else {
                    usersData[username] = {
                        password: password, // CRITICAL SECURITY FLAW FOR REAL APPS
                        balance: INITIAL_BALANCE, // Set initial balance for new user
                        portfolio: {},
                        history: [],
                        favorites: [] // Initialize empty favorites for new user
                    };
                    localStorage.setItem('users', JSON.stringify(usersData));
                    displayAuthMessage("Registration successful! You can now log in.", false);
                    toggleAuthMode();
                }
            } else { // Login mode
                if (usersData[username] && usersData[username].password === password) {
                    currentUser = username;
                    displayAuthMessage("Login successful!", false);
                    closeAllPopups();
                    loginSuccess();
                } else {
                    displayAuthMessage("Invalid username or password.", true);
                }
            }
        }

        function loginSuccess() {
            userInfoSpan.textContent = `Welcome, ${currentUser}!`;
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            resetAccountBtn.style.display = 'inline-block'; // Show reset button
            resetPricesBtn.style.display = 'inline-block'; // Show reset prices button
            mainContentDiv.style.display = 'flex';
            loadUserData(); // This will now load companies data too
            startPriceUpdates();
            startNotificationUpdates(); // Start notifications after login
            localStorage.setItem('lastLoggedInUser', currentUser); // Persist last logged in user
        }

        function logout() {
            if (priceUpdateIntervalId) {
                clearInterval(priceUpdateIntervalId);
            }
            if (notificationIntervalId) { // Clear notification interval on logout
                clearInterval(notificationIntervalId);
            }
            // Destroy all mini-chart instances to prevent memory leaks
            for (const symbol in miniCharts) {
                if (miniCharts[symbol]) {
                    miniCharts[symbol].destroy();
                    delete miniCharts[symbol];
                }
            }
            saveUserData(); // Save current user's data and companies data before logging out

            currentUser = null;
            userBalance = 0.00; // Reset balance on logout
            portfolio = {};
            transactionHistory = [];
            favoriteCompanies = []; // Clear favorites on logout
            updateBalanceDisplay();
            updateAccountPLDisplay(); // Update account P/L after logout
            updatePortfolioDisplay();
            updateHistoryDisplay();
            userInfoSpan.textContent = '';
            loginBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            resetAccountBtn.style.display = 'none'; // Hide reset button
            resetPricesBtn.style.display = 'none'; // Hide reset prices button
            mainContentDiv.style.display = 'none';
            
            // Reset companies to default state for next session start if not explicitly saved
            // This is handled by loadUserData on next login, so no need to explicitly reset here.
            
            renderCompanies(); // Re-render with default state (no favorites)
            closeAllPopups();
            localStorage.removeItem('lastLoggedInUser'); // Remove last logged in user
            openAuthPopup('login'); // Redirect to login page
        }

        function resetAccount() {
            if (!currentUser) return; // Should not happen if button is shown
            const confirmReset = window.confirm(`Are you sure you want to reset your account, ${currentUser}? This will delete all your trades and reset your balance.`);
            if (confirmReset) {
                delete usersData[currentUser]; // Delete user data from global object
                localStorage.setItem('users', JSON.stringify(usersData)); // Update localStorage
                window.alert("Your account has been reset. You will now be logged out.");
                logout(); // Log out and go to login screen
            }
        }

        function resetPrices() {
            if (!currentUser) {
                // This case should ideally not be reachable if the button is hidden when not logged in
                return;
            }
            // Using a custom modal instead of alert/confirm for better UX and consistency
            const userConfirmed = window.confirm("Are you sure you want to reset all stock prices to their base values? This cannot be undone.");

            if (userConfirmed) {
                // Reset each company's price and history to its initial state
                companies.forEach(company => {
                    const initialData = INITIAL_COMPANIES_DATA.find(d => d.symbol === company.symbol);
                    if (initialData) {
                        company.price = initialData.price; // Set to base price
                        company.history = [initialData.price]; // Reset history to just the initial base price
                    }
                });
                renderCompanies(); // Re-render the market overview
                updatePortfolioDisplay(); // Portfolio values might be affected by price changes
                updateAccountPLDisplay(); // Account P/L might be affected
                saveUserData(); // Save the new company states (which now include reset prices)
                showNotification("All stock prices have been reset to their base values.");
            }
        }

        // --- Utility for Chart.js color conversion ---
        function varToRgba(cssVar, opacity) {
            const style = getComputedStyle(document.documentElement);
            const color = style.getPropertyValue(cssVar).trim();
            if (color.startsWith('#') && color.length === 7) {
                const r = parseInt(color.substring(1, 3), 16);
                const g = parseInt(color.substring(3, 5), 16);
                const b = parseInt(color.substring(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color;
        }

        // --- Initialization ---
        function startPriceUpdates() {
            if (priceUpdateIntervalId) {
                clearInterval(priceUpdateIntervalId);
            }
            // `loadUserData` already initializes/trims company histories, so no need here.
            renderCompanies();
            priceUpdateIntervalId = setInterval(() => {
                updateAllStockPrices();
                updateMiniCharts(); // Update mini charts on price change
            }, PRICE_UPDATE_INTERVAL);
        }

        function startNotificationUpdates() {
            if (notificationIntervalId) {
                clearInterval(notificationIntervalId);
            }
            notificationIntervalId = setInterval(() => {
                const randomMessage = newsMessages[Math.floor(Math.random() * newsMessages.length)];
                showNotification(randomMessage);
            }, NOTIFICATION_INTERVAL);
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Load all users data to check for last logged in user
            usersData = JSON.parse(localStorage.getItem('users') || '{}');

            const lastLoggedInUser = localStorage.getItem('lastLoggedInUser');
            if (lastLoggedInUser && usersData[lastLoggedInUser]) {
                currentUser = lastLoggedInUser;
                loginSuccess();
            } else {
                // Initial load of companies data even before login to display market
                loadUserData(); 
                openAuthPopup('login');
            }
        });

        // Save data on browser close/tab close
        window.addEventListener('beforeunload', () => {
            saveUserData();
        });
    </script>
</body>
</html>
